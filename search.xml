<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>go语言基础7--defer相关</title>
    <url>/2022/08/24/go10/</url>
    <content><![CDATA[<h2 id="1-多个defer语句，按先进后出的方式执行"><a href="#1-多个defer语句，按先进后出的方式执行" class="headerlink" title="1. 多个defer语句，按先进后出的方式执行"></a>1. 多个defer语句，按先进后出的方式执行</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main 
<span class="token keyword">import</span> <span class="token string">"fmt"</span> 
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    <span class="token keyword">var</span> whatever <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span>s<span class="token punctuation">&#125;</span>    
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> whatever <span class="token punctuation">&#123;</span>
        <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>    
    <span class="token punctuation">&#125;</span> 
<span class="token punctuation">&#125;</span>

<span class="token comment">//4</span>
<span class="token comment">//3</span>
<span class="token comment">//2</span>
<span class="token comment">//1</span>
<span class="token comment">//0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<span id="more"></span>

<h2 id="2-易错点：defer加func函数带return"><a href="#2-易错点：defer加func函数带return" class="headerlink" title="2. 易错点：defer加func函数带return"></a>2. 易错点：defer加func函数带return</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main 
<span class="token keyword">import</span> <span class="token string">"fmt"</span> 
<span class="token comment">//测试函数带参数  直接返回函数参数x再调用defer</span>
<span class="token keyword">func</span> <span class="token function">test1</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span>
<span class="token comment">//测试函数带参数 先赋值x 然后回回函数参数x再调用defer</span>
<span class="token keyword">func</span> <span class="token function">test11</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	x <span class="token operator">=</span> <span class="token number">10</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span>
<span class="token comment">//测试函数返回值带参数 先赋值x 然后回回函数参数x再调用defer 但是defer内参数x与返回值参数名相同 直接覆盖原返回值 </span>
<span class="token comment">//结尾return x 是诱导 可以不用写返回值</span>
<span class="token keyword">func</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	x <span class="token operator">=</span> <span class="token number">10</span>
	<span class="token keyword">return</span> x
    <span class="token comment">//return </span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//测试函数返回值带参数 同上 覆盖并调用defer得 返回值为10</span>
<span class="token keyword">func</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> x <span class="token operator">=</span> <span class="token number">9</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">test1</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//1</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">test11</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//10</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//9</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//10</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>总结：</strong> 执行逻辑 </p>
<p>测试函数-&gt;非defer测试函数内局部变量赋值-&gt;return 变量 -&gt;defer函数（如果测试函数有返回值函数且内部变量与返回值参数同名，覆盖return变量值）</p>
<blockquote>
<p><strong>更多defer用法参考：</strong> <a href="https://cloud.tencent.com/developer/article/2002791">Go 延迟调用 defer 用法详解 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
</blockquote>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>defer</tag>
      </tags>
  </entry>
  <entry>
    <title>控制gorutine顺序输出（生产者——消费者）</title>
    <url>/2022/09/08/go11/</url>
    <content><![CDATA[<h3 id="以此铭记失败的面试"><a href="#以此铭记失败的面试" class="headerlink" title="以此铭记失败的面试"></a>以此铭记失败的面试</h3><blockquote>
<p>go协程开启后是并发执行且无序的；开启100个协程如何对其进行顺序执行?</p>
</blockquote>
<span id="more"></span>

<h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token comment">//控制数量</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">producter</span><span class="token punctuation">(</span>out <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> in <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//阻塞 如果out没有值就一直阻塞</span>
	key <span class="token operator">:=</span> <span class="token operator">&lt;-</span>out
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产："</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token comment">//输入消费管道</span>
	in <span class="token operator">&lt;-</span> key
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">consumer</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"消费："</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//需要消费的缓冲管道</span>
	in <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//生产管道</span>
		ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">//开启生产协程</span>
		<span class="token keyword">go</span> <span class="token function">producter</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> in<span class="token punctuation">)</span>
		<span class="token comment">//将i顺序输入管道</span>
		ch <span class="token operator">&lt;-</span> i
		<span class="token comment">//当前协程销毁才能进行下一个</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//关闭in通道 不然会出错</span>
	<span class="token function">close</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">consumer</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>下一步计划，尽量熟悉go语言协程开发，不要只停留于理论！吸取教训！</strong></p>
<h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token comment">//实现有缓冲区与无缓冲区 消费者生产者</span>
<span class="token keyword">var</span> myCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> exitCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">producter</span><span class="token punctuation">(</span>zhu <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num <span class="token operator">:=</span> <span class="token operator">&lt;-</span>zhu
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产了:"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
	myCh <span class="token operator">&lt;-</span> num
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> num<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>myCh<span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"消费了:"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"停止消费"</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	exitCh <span class="token operator">&lt;-</span> <span class="token boolean">true</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		zhu <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">producter</span><span class="token punctuation">(</span>zhu<span class="token punctuation">)</span>
		zhu <span class="token operator">&lt;-</span> i
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>zhu<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//wg.Wait()</span>
	<span class="token function">close</span><span class="token punctuation">(</span>myCh<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//wg.Wait()</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exitCh前"</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>exitCh
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exitCh后"</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础1——make和new</title>
    <url>/2022/08/17/go1/</url>
    <content><![CDATA[<h5 id="golang中make和new的区别"><a href="#golang中make和new的区别" class="headerlink" title="golang中make和new的区别"></a>golang中make和new的区别</h5><p>共同点：都是给变量分配内存；<br>不同点：</p>
<ol>
<li><p>返回类型不同： new创建返回指针，指向分配类型的指针，分配的空间置为零，该类型的零值；make返回变量本身，分配空间后会进行初始；</p>
</li>
<li><p>分配类型：new可以为任意类型进行分配；make只能为slice，map，chan引用类型数据进行分配空间。</p>
</li>
</ol>
<h5 id="数组和切片的区别"><a href="#数组和切片的区别" class="headerlink" title="数组和切片的区别"></a>数组和切片的区别</h5><p>共同点：都是通过下标访问，并且都有容量长度；</p>
<p>不同点：</p>
<ol>
<li>定义方式不同：数组必须指定大小，定义后不能增加容量和长度；切片不用，定义后切片数据增多，会自动扩容（当原切片长度小于1024时，新切片的容量会直接翻倍；超过1024会反复地增加25%，直到新容量超过所需要的容量）；</li>
<li>类型不同：数值为值类型；切片为引用类型，每个切片底层引用一个数组，所以切片扩容后，便会指向一个新的底层数组，内存地址跟着改变。</li>
</ol>
<span id="more"></span>

<h5 id="for-range-的时候它的地址会发生变化么？"><a href="#for-range-的时候它的地址会发生变化么？" class="headerlink" title="for range 的时候它的地址会发生变化么？"></a>for range 的时候它的地址会发生变化么？</h5><p>在 for a,b := range c 遍历中，a,b只会存一份地址，循环后会重新赋值，内存地址不变；因此for中创建协程后不要传入a或b的地址，可以再循环中通过创建临时变量解决。</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>数组</tag>
        <tag>切片</tag>
      </tags>
  </entry>
  <entry>
    <title>go基础8-Select相关</title>
    <url>/2022/09/13/go12/</url>
    <content><![CDATA[<h3 id="Select的作用"><a href="#Select的作用" class="headerlink" title="Select的作用"></a>Select的作用</h3><p><strong>select主要用于实现多路监听、实现超时处理</strong></p>
<ul>
<li>select case后面必须是一个IO操作</li>
<li>一般情况下不用写default</li>
</ul>
<p><strong>select是Go中的一个控制结构，类似于switch语句，用于处理异步I0操作</strong></p>
<span id="more"></span>

<ul>
<li><p>如果有多个case都可以运行，select会随机选出一个执行,其他不会执行。</p>
</li>
<li><p>如果没有可运行的case语句，且有default语句， 那么就会执行default的动作。</p>
</li>
<li><p>如果没有可运行的case语句，且没有default语句， select将阻塞，直到某个case通信可以运</p>
</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> IO操作<span class="token number">1</span><span class="token punctuation">:</span>
		I0操作<span class="token number">1</span>读取或写入成功就执行
	<span class="token keyword">case</span> IO操作<span class="token number">2</span><span class="token punctuation">:</span>
		IO操作<span class="token number">2</span>读取或写入成功就执行
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		如果上面<span class="token keyword">case</span>都没有成功，则进入<span class="token keyword">default</span>处理流程
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>channel</tag>
      </tags>
  </entry>
  <entry>
    <title>控制gorutine并发数量</title>
    <url>/2022/09/13/go13/</url>
    <content><![CDATA[<h3 id="控制并发数量可以避免服务器奔溃：以下方式尝试控制"><a href="#控制并发数量可以避免服务器奔溃：以下方式尝试控制" class="headerlink" title="控制并发数量可以避免服务器奔溃：以下方式尝试控制"></a>控制并发数量可以避免服务器奔溃：以下方式尝试控制</h3><blockquote>
<p>注意：多个并发协程之间不需要通信，那么就可以使用 sync.WaitGroup</p>
<p>如果并发启动了多个子协程，需要等待所有的子协程完成任务，WaitGroup 非常适合于这类场景</p>
</blockquote>
<ul>
<li><strong>只是用Chan控制</strong></li>
</ul>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token comment">//控制并发数量 chan</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   count <span class="token operator">:=</span> <span class="token number">10</span>
   ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
      ch <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
      <span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>
   <span class="token comment">//time.Sleep(time.Second * 2)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"个协程"</span><span class="token punctuation">,</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment">//为了测试并发数量</span>
   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
   <span class="token operator">&lt;-</span>ch
<span class="token punctuation">&#125;</span>
<span class="token comment">/* 以下为输出---（应该输出10个）
第 1 个协程 1663071133
第 0 个协程 1663071133
第 2 个协程 1663071134
第 3 个协程 1663071134
第 4 个协程 1663071135
第 5 个协程 1663071135
第 6 个协程 1663071136
第 7 个协程 1663071136
第 8 个协程 1663071137
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>出现问题：</strong>看似达到控制2个2个输出的效果，但是主协程结束时，子协程也是会被终止掉的，因此剩余的 goroutine 没来及把值输出，</p>
<ul>
<li><strong>只使用Sync.WaitGroup</strong></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Sync控制</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	count <span class="token operator">:=</span> <span class="token number">10</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"个协程"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//为了测试并发数量</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* 以下为输出---（应该输出10个）
第 9 个协程 1663070879
第 4 个协程 1663070879
第 2 个协程 1663070879
第 3 个协程 1663070879
第 0 个协程 1663070879
第 6 个协程 1663070879
第 5 个协程 1663070879
第 7 个协程 1663070879
第 8 个协程 1663070879
第 1 个协程 1663070879
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>出现问题：</strong>没有达到控制2个2个输出的效果。</p>
<ul>
<li><strong>使用Sync.WaitGroup+Chan</strong></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//Sync+Chan</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	count <span class="token operator">:=</span> <span class="token number">10</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        ch <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//TODO</span>
	<span class="token comment">//ch &lt;- true 放在里面吃内存（待处理 ）</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"个协程"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//为了测试并发数量</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>ch
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 以下为输出---（应该输出10个）
第 1 个协程 1663071133
第 0 个协程 1663071133
第 2 个协程 1663071134
第 3 个协程 1663071134
第 4 个协程 1663071135
第 5 个协程 1663071135
第 6 个协程 1663071136
第 7 个协程 1663071136
第 8 个协程 1663071137
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>成功：</strong>达到控制2个2个输出的效果。</p>
<h3 id="新场景——控制输入的数量，以此达到改变允许并发运行-goroutine-的数量（灵活控制）"><a href="#新场景——控制输入的数量，以此达到改变允许并发运行-goroutine-的数量（灵活控制）" class="headerlink" title="新场景——控制输入的数量，以此达到改变允许并发运行 goroutine 的数量（灵活控制）"></a>新场景——控制输入的数量，以此达到改变允许并发运行 goroutine 的数量（灵活控制）</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"sync"</span>
    <span class="token string">"time"</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> count <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	userCount <span class="token operator">:=</span> <span class="token number">10</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> userCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">&#123;</span>
				count<span class="token operator">++</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token string">"个协程"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//输入几个ch 就有几个*userCount个协程</span>
		ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
		ch <span class="token operator">&lt;-</span> <span class="token number">2</span>
		ch <span class="token operator">&lt;-</span> <span class="token number">3</span>
		<span class="token comment">//time.Sleep(time.Second)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* 以下为输出---（应该输出30个）
第 1 个协程 1663072405
第 2 个协程 1663072405 
第 4 个协程 1663072405 
第 5 个协程 1663072405 
第 6 个协程 1663072405 
第 7 个协程 1663072405 
第 8 个协程 1663072405 
第 9 个协程 1663072405 
第 10 个协程 1663072405
第 3 个协程 1663072405 
第 12 个协程 1663072406
第 13 个协程 1663072406
第 14 个协程 1663072406
第 11 个协程 1663072406
第 15 个协程 1663072407
第 16 个协程 1663072407
第 17 个协程 1663072407
第 18 个协程 1663072407
第 19 个协程 1663072408
第 20 个协程 1663072408
第 21 个协程 1663072408
第 22 个协程 1663072408
第 23 个协程 1663072408
第 24 个协程 1663072408
第 25 个协程 1663072409
第 26 个协程 1663072409
第 28 个协程 1663072409
第 27 个协程 1663072409
第 29 个协程 1663072410
第 30 个协程 1663072410
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Context控制gorutine并发</title>
    <url>/2022/09/14/go14/</url>
    <content><![CDATA[<p>更复杂的场景如何做并发控制呢？比如子协程中开启了新的子协程，或者需要同时控制多个子协程。这种场景下，<code>select+chan</code>的方式就显得力不从心了。Go 语言提供了 Context 标准库可以解决这类场景的问题，Context 的作用和它的名字很像，上下文，即子协程的下上文。Context 有两个主要的功能：</p>
<ul>
<li>通知子协程退出（正常退出，超时退出等）；</li>
<li>传递必要的参数。</li>
</ul>
<span id="more"></span>

<h2 id="1-context-WithCancel"><a href="#1-context-WithCancel" class="headerlink" title="1.context.WithCancel"></a>1.context.WithCancel</h2><h3 id="select-chan定时轮询"><a href="#select-chan定时轮询" class="headerlink" title="select+chan定时轮询"></a><code>select+chan</code>定时轮询</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> stop <span class="token keyword">chan</span> <span class="token builtin">bool</span>

<span class="token keyword">func</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token operator">&lt;-</span>stop<span class="token punctuation">:</span>
         fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
         <span class="token keyword">return</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
         fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"send ing"</span><span class="token punctuation">)</span>
         time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   stop <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
   <span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span><span class="token string">"work1"</span><span class="token punctuation">)</span>
   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
   stop <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
   time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/* 输出：
work1 send ing
work1 send ing
work1 send ing
准备结束
stop work1
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="在上述基础上使用context-WithCancel"><a href="#在上述基础上使用context-WithCancel" class="headerlink" title="在上述基础上使用context.WithCancel"></a>在上述基础上使用context.WithCancel</h3><p><code>context.WithCancel()</code> 创建可取消的 Context 对象，即可以主动通知子协程退出。</p>
<h4 id="控制单个协程"><a href="#控制单个协程" class="headerlink" title="控制单个协程"></a>控制单个协程</h4><ul>
<li><code>context.Backgroud()</code> 创建根 Context，通常在 main 函数、初始化和测试代码中创建，作为顶层 Context。</li>
<li><code>context.WithCancel(parent)</code> 创建可取消的子 Context，同时返回函数 <code>cancel</code>。</li>
<li>在子协程中，使用 select 调用 <code>&lt;-ctx.Done()</code> 判断是否需要退出。</li>
<li>主协程中，调用 <code>cancel()</code> 函数通知子协程退出。</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"send ing"</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"work2"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*输出：
work2 send ing
work2 send ing
work2 send ing
准备结束
stop work2
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="控制多个协程"><a href="#控制多个协程" class="headerlink" title="控制多个协程"></a>控制多个协程</h4><p><strong>只需要多启用协程即可</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//多协程示例</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"work2"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"work3"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"work4"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*输出：
work4 send ing
work2 send ing
work3 send ing
work2 send ing
work3 send ing
work4 send ing
work2 send ing
work3 send ing
work4 send ing
准备结束
stop work4
stop work3
stop work2
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-context-WithValue"><a href="#2-context-WithValue" class="headerlink" title="2.context.WithValue"></a>2.context.WithValue</h2><p>如果需要往子协程中传递参数，可以使用 <code>context.WithValue()</code>。</p>
<ul>
<li><code>context.WithValue()</code> 创建了一个基于 <code>ctx</code> 的子 Context，并携带了值 <code>options</code>。</li>
<li>在子协程中，使用 <code>ctx.Value(&quot;options&quot;)</code> 获取到传递的值，读取/修改该值。</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Target <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	name <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">//Value获取的是any 接口型值 需要.(*Target)类型断言 将v获取为*Target类型</span>
			v <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Target<span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"send ing--"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	testV1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小张"</span><span class="token punctuation">&#125;</span>
	testV2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小李"</span><span class="token punctuation">&#125;</span>
	vCtx1 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV1<span class="token punctuation">)</span>
	vCtx2 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV2<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx1<span class="token punctuation">,</span> <span class="token string">"work2"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx2<span class="token punctuation">,</span> <span class="token string">"work3"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
work3 send ing-- 小李
work2 send ing-- 小张
work3 send ing-- 小李
work2 send ing-- 小张
work2 send ing-- 小张
work3 send ing-- 小李
work2 send ing-- 小张
准备结束  
stop work3
stop work2
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-context-WithTimeout"><a href="#3-context-WithTimeout" class="headerlink" title="3.context.WithTimeout"></a>3.context.WithTimeout</h2><p>如果需要控制子协程的执行时间，可以使用 <code>context.WithTimeout</code> 创建具有超时通知机制的 Context 对象</p>
<p>因为超时时间设置为 2s，但是 main 函数中，3s 后才会调用 <code>cancel()</code>，因此，在调用 <code>cancel()</code> 函数前，子协程因为超时已经退出了。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Target <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	name <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		i<span class="token operator">++</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>

			<span class="token comment">//Value获取的是any 接口型值 需要.(*Target)类型断言 将v获取为*Target类型</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			v <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Target<span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"send ing--"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"第："</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//ctx, cancel := context.WithCancel(context.Background())</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	testV1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小张"</span><span class="token punctuation">&#125;</span>
	testV2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小李"</span><span class="token punctuation">&#125;</span>
	vCtx1 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV1<span class="token punctuation">)</span>
	vCtx2 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV2<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx1<span class="token punctuation">,</span> <span class="token string">"work2"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx2<span class="token punctuation">,</span> <span class="token string">"work3"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
work3 send ing-- 小李 第： 1 秒
work2 send ing-- 小张 第： 1 秒
work2 send ing-- 小张 第： 2 秒
stop work2                     
work3 send ing-- 小李 第： 2 秒
stop work3                     
准备结束
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-context-WithDeadline"><a href="#4-context-WithDeadline" class="headerlink" title="4.context.WithDeadline"></a>4.context.WithDeadline</h2><p>超时退出可以控制子协程的最长执行时间，那 <code>context.WithDeadline()</code> 则可以控制子协程的最迟退出时间</p>
<ul>
<li><code>WithDeadline</code> 用于设置截止时间。在这个例子中，将截止时间设置为2s后，<code>cancel()</code> 函数在 3s 后调用，因此子协程将在调用 <code>cancel()</code> 函数前结束。</li>
<li>在子协程中，可以通过 <code>ctx.Err()</code> 获取到子协程退出的错误原因。</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Target <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	name <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		i<span class="token operator">++</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">"退出错误显示："</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>

			<span class="token comment">//Value获取的是any 接口型值 需要.(*Target)类型断言 将v获取为*Target类型</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
			v <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Target<span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"send ing--"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"第："</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"秒"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//ctx, cancel := context.WithCancel(context.Background())</span>
	<span class="token comment">//ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span>
	testV1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小张"</span><span class="token punctuation">&#125;</span>
	testV2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Target<span class="token punctuation">&#123;</span><span class="token string">"小李"</span><span class="token punctuation">&#125;</span>
	vCtx1 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV1<span class="token punctuation">)</span>
	vCtx2 <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> testV2<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx1<span class="token punctuation">,</span> <span class="token string">"work2"</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">reqTask</span><span class="token punctuation">(</span>vCtx2<span class="token punctuation">,</span> <span class="token string">"work3"</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"准备结束"</span><span class="token punctuation">)</span>
	<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*
work3 send ing-- 小李 第： 1 秒
work2 send ing-- 小张 第： 1 秒
work2 send ing-- 小张 第： 2 秒
stop work2 退出错误显示： context deadline exceeded
work3 send ing-- 小李 第： 2 秒                    
stop work3 退出错误显示： context deadline exceeded
准备结束
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>context deadline exceeded 因为截止时间到了而退出</strong></p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
        <tag>context</tag>
      </tags>
  </entry>
  <entry>
    <title>go二均值抢红包算法</title>
    <url>/2022/09/19/go17/</url>
    <content><![CDATA[<blockquote>
<p>微信抢红包算法—–go语言实现</p>
</blockquote>
<p>主要使用Rand随机+二均值方法实现</p>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	
	count<span class="token punctuation">,</span> money <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span>
	<span class="token comment">//红包总和 验证发了多少钱</span>
	sum <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token comment">//发红包</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		x <span class="token operator">:=</span> <span class="token function">SecAvg</span><span class="token punctuation">(</span>count<span class="token operator">-</span>i<span class="token punctuation">,</span> money<span class="token punctuation">)</span>
		<span class="token comment">//剩余钱</span>
		money <span class="token operator">-=</span> x
		<span class="token comment">//发了多少钱</span>
		sum <span class="token operator">+=</span> x
		<span class="token comment">//领红包数</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"个人领了"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">"元"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"一共发了"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token string">"元"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">SecAvg</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> money <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//红包最小值</span>
	min <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> money
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//二均值法 （0，（剩余钱/剩余人数）*2）==[min,max/count * 2]</span>
	<span class="token comment">//上边界 左开右开 避免为0</span>
	max <span class="token operator">:=</span> money <span class="token operator">-</span> min
	right <span class="token operator">:=</span> <span class="token punctuation">(</span>max<span class="token operator">/</span>count<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> min
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//[min,max/count * 2]</span>
	x <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">+</span> min
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
第 1 个人领了 24 元
第 2 个人领了 24 元
第 3 个人领了 26 元
第 4 个人领了 15 元
第 5 个人领了 36 元
第 6 个人领了 20 元
第 7 个人领了 20 元
第 8 个人领了 17 元
第 9 个人领了 17 元
第 10 个人领了 1 元
一共发了 200 元
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>红包到小数点后两位</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">	count<span class="token punctuation">,</span> money <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token comment">//200为2元 定钱需要 *100</span>
	<span class="token comment">//红包总和 验证发了多少钱</span>
	sum <span class="token operator">:=</span> <span class="token function">float32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token comment">//发红包</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		x <span class="token operator">:=</span> <span class="token function">SecAvg</span><span class="token punctuation">(</span>count<span class="token operator">-</span>i<span class="token punctuation">,</span> money<span class="token punctuation">)</span>
		<span class="token comment">//剩余钱</span>
		money <span class="token operator">-=</span> x
		<span class="token comment">//发了多少钱</span>
		sum <span class="token operator">+=</span> <span class="token function">float32</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
		<span class="token comment">//领红包数</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"个人领了"</span><span class="token punctuation">,</span> <span class="token function">float32</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float32</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"元"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"一共发了"</span><span class="token punctuation">,</span> sum<span class="token operator">/</span><span class="token function">float32</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"元"</span><span class="token punctuation">)</span>

<span class="token comment">/*
第 1 个人领了 0.2 元
第 2 个人领了 0.24 元
第 3 个人领了 0.24 元
第 4 个人领了 0.27 元
第 5 个人领了 0.26 元
第 6 个人领了 0.26 元
第 7 个人领了 0.18 元
第 8 个人领了 0.1 元 
第 9 个人领了 0.06 元
第 10 个人领了 0.19 元
一共发了 2 元
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>交替打印字母和数字</title>
    <url>/2022/09/18/go15/</url>
    <content><![CDATA[<p>两个 <code>channel</code> 负责通知，english 负责通知打印字母的 <code>goroutine </code>来打印字母，num用来通知打印数字的 <code>goroutine </code> 打印数字。</p>
<p><code>wait </code>用来等待字母打印完成后退出循环。</p>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	num<span class="token punctuation">,</span> english <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
	str <span class="token operator">:=</span> <span class="token string">"ABCD"</span>
	<span class="token comment">//fmt.Println(strings.Count(str[2:], ""))</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		i <span class="token operator">:=</span> <span class="token number">1</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> v<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token operator">&lt;-</span>num<span class="token punctuation">:</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>v <span class="token punctuation">&#123;</span>
					wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
				i<span class="token operator">++</span>
				english <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
				<span class="token keyword">break</span>

			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		i <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>english<span class="token punctuation">:</span>
				<span class="token comment">//strings.Count “” 结束判断</span>
				<span class="token comment">//fmt.Println("判断条件", strings.Count(str, "")-1)</span>
				<span class="token keyword">if</span> i <span class="token operator">>=</span> strings<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
					num <span class="token operator">&lt;-</span> <span class="token boolean">false</span>
					wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i <span class="token punctuation">:</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				i<span class="token operator">++</span>
				num <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
				<span class="token keyword">break</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>

		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	num <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>go基础9-Math/Rand包相关</title>
    <url>/2022/09/19/go16/</url>
    <content><![CDATA[<h3 id="type-Source"><a href="#type-Source" class="headerlink" title="type Source"></a>type <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#18">Source</a></h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Source <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
    <span class="token function">Int63</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>
    <span class="token function">Seed</span><span class="token punctuation">(</span>seed <span class="token builtin">int64</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Source代表一个生成均匀分布在范围[0, 1&lt;&lt;63)的int64值的（伪随机的）资源。</p>
<h4 id="func-NewSource"><a href="#func-NewSource" class="headerlink" title="func NewSource"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#24">NewSource</a></h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewSource</span><span class="token punctuation">(</span>seed <span class="token builtin">int64</span><span class="token punctuation">)</span> Source<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用给定的种子创建一个伪随机资源。</p>
<span id="more"></span>

<h3 id="type-Rand"><a href="#type-Rand" class="headerlink" title="type Rand"></a>type <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#31">Rand</a></h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Rand <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 内含隐藏或非导出字段</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Rand生成服从多种分布的随机数。</p>
<h4 id="func-New"><a href="#func-New" class="headerlink" title="func New"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#37">New</a></h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>src Source<span class="token punctuation">)</span> <span class="token operator">*</span>Rand<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个使用src生产的随机数来生成其他各种分布的随机数值的*Rand。</p>
<h4 id="func-Rand-Seed"><a href="#func-Rand-Seed" class="headerlink" title="func (*Rand) Seed"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#40">Seed</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Seed(seed int64)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用给定的seed来初始化生成器到一个确定的状态。</p>
<h4 id="func-Rand-Int"><a href="#func-Rand-Int" class="headerlink" title="func (*Rand) Int"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#52">Int</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Int() int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个非负的伪随机int值。</p>
<h4 id="func-Rand-Int31"><a href="#func-Rand-Int31" class="headerlink" title="func (*Rand) Int31"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#49">Int31</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Int31() int32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个int32类型的非负的31位伪随机数。</p>
<h4 id="func-Rand-Int63"><a href="#func-Rand-Int63" class="headerlink" title="func (*Rand) Int63"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#43">Int63</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Int63() int64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个int64类型的非负的63位伪随机数。</p>
<h4 id="func-Rand-Uint32"><a href="#func-Rand-Uint32" class="headerlink" title="func (*Rand) Uint32"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#46">Uint32</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Uint32() uint32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个uint32类型的非负的32位伪随机数。</p>
<h4 id="func-Rand-Intn"><a href="#func-Rand-Intn" class="headerlink" title="func (*Rand) Intn"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#93">Intn</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Intn(n int) int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0,n)的伪随机int值，如果n&lt;=0会panic。</p>
<h4 id="func-Rand-Int31n"><a href="#func-Rand-Int31n" class="headerlink" title="func (*Rand) Int31n"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#76">Int31n</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Int31n(n int32) int32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0,n)的伪随机int32值，如果n&lt;=0会panic</p>
<h4 id="func-Rand-Int63n"><a href="#func-Rand-Int63n" class="headerlink" title="func (*Rand) Int63n"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#59">Int63n</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Int63n(n int64) int64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0,n)的伪随机int64值，如果n&lt;=0会panic。</p>
<h4 id="func-Rand-Float32"><a href="#func-Rand-Float32" class="headerlink" title="func (*Rand) Float32"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#131">Float32</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Float32() float32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0.0, 1.0)的伪随机float32值。</p>
<h4 id="func-Rand-Float64"><a href="#func-Rand-Float64" class="headerlink" title="func (*Rand) Float64"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#104">Float64</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Float64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0.0, 1.0)的伪随机float64值。</p>
<h4 id="func-Rand-NormFloat64"><a href="#func-Rand-NormFloat64" class="headerlink" title="func (*Rand) NormFloat64"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/normal.go?name=release#38">NormFloat64</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) NormFloat64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个服从标准正态分布（标准差=1，期望=0）、取值范围在[-math.MaxFloat64, +math.MaxFloat64]的float64值</p>
<p>如果要生成不同的正态分布值，调用者可用如下代码调整输出：</p>
<pre class="line-numbers language-none"><code class="language-none">sample &#x3D; NormFloat64() * 标准差 + 期望<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="func-Rand-ExpFloat64"><a href="#func-Rand-ExpFloat64" class="headerlink" title="func (*Rand) ExpFloat64"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/exp.go?name=release#31">ExpFloat64</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) ExpFloat64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个服从标准指数分布（率参数=1，率参数是期望的倒数）、取值范围在(0, +math.MaxFloat64]的float64值</p>
<p>如要生成不同的指数分布值，调用者可用如下代码调整输出：</p>
<pre class="line-numbers language-none"><code class="language-none">sample &#x3D; ExpFloat64() &#x2F; 率参数<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="func-Rand-Perm"><a href="#func-Rand-Perm" class="headerlink" title="func (*Rand) Perm"></a>func (*Rand) <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#146">Perm</a></h4><pre class="line-numbers language-none"><code class="language-none">func (r *Rand) Perm(n int) []int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个有n个元素的，[0,n)范围内整数的伪随机排列的切片。</p>
<h3 id="type-Zipf"><a href="#type-Zipf" class="headerlink" title="type Zipf"></a>type <a href="https://github.com/golang/go/blob/master/src/math/rand/zipf.go?name=release#15">Zipf</a></h3><pre class="line-numbers language-none"><code class="language-none">type Zipf struct &#123;
    &#x2F;&#x2F; 内含隐藏或非导出字段
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Zipf生成服从齐普夫分布的随机数。</p>
<h4 id="func-NewZipf"><a href="#func-NewZipf" class="headerlink" title="func NewZipf"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/zipf.go?name=release#37">NewZipf</a></h4><pre class="line-numbers language-none"><code class="language-none">func NewZipf(r *Rand, s float64, v float64, imax uint64) *Zipf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>NewZipf返回一个[0, imax]范围内的齐普夫随机数生成器。</p>
<p>齐普夫分布：值k出现的几率p(k)正比于(v+k)**(-s)，其中s&gt;1且k&gt;=0且v&gt;=1。</p>
<h4 id="func-Zipf-Uint64"><a href="#func-Zipf-Uint64" class="headerlink" title="func (*Zipf) Uint64"></a>func (*Zipf) <a href="https://github.com/golang/go/blob/master/src/math/rand/zipf.go?name=release#56">Uint64</a></h4><pre class="line-numbers language-none"><code class="language-none">func (z *Zipf) Uint64() uint64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Uint64返回一个服从Zipf对象描述的齐普夫分布的随机数。</p>
<h3 id="func-Seed"><a href="#func-Seed" class="headerlink" title="func Seed"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#165">Seed</a></h3><pre class="line-numbers language-none"><code class="language-none">func Seed(seed int64)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用给定的seed将默认资源初始化到一个确定的状态；如未调用Seed，默认资源的行为就好像调用了Seed(1)。</p>
<h3 id="func-Int"><a href="#func-Int" class="headerlink" title="func Int"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#180">Int</a></h3><pre class="line-numbers language-none"><code class="language-none">func Int() int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个非负的伪随机int值。</p>
<h3 id="func-Int31"><a href="#func-Int31" class="headerlink" title="func Int31"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#177">Int31</a></h3><pre class="line-numbers language-none"><code class="language-none">func Int31() int32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个int32类型的非负的31位伪随机数。</p>
<h3 id="func-Int63"><a href="#func-Int63" class="headerlink" title="func Int63"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#169">Int63</a></h3><pre class="line-numbers language-none"><code class="language-none">func Int63() int64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个int64类型的非负的63位伪随机数。</p>
<h3 id="func-Uint32"><a href="#func-Uint32" class="headerlink" title="func Uint32"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#173">Uint32</a></h3><pre class="line-numbers language-none"><code class="language-none">func Uint32() uint32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个uint32类型的非负的32位伪随机数。</p>
<h3 id="func-Intn"><a href="#func-Intn" class="headerlink" title="func Intn"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#195">Intn</a></h3><pre class="line-numbers language-none"><code class="language-none">func Intn(n int) int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0,n)的伪随机int值，如果n&lt;=0会panic。</p>
<h3 id="func-Int31n"><a href="#func-Int31n" class="headerlink" title="func Int31n"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#190">Int31n</a></h3><pre class="line-numbers language-none"><code class="language-none">func Int31n(n int32) int32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0,n)的伪随机int32值，如果n&lt;=0会panic。</p>
<h3 id="func-Int63n"><a href="#func-Int63n" class="headerlink" title="func Int63n"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#185">Int63n</a></h3><pre class="line-numbers language-none"><code class="language-none">func Int63n(n int64) int64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0, n)的伪随机int64值，如果n&lt;=0会panic。</p>
<h3 id="func-Float32"><a href="#func-Float32" class="headerlink" title="func Float32"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#203">Float32</a></h3><pre class="line-numbers language-none"><code class="language-none">func Float32() float32<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0.0, 1.0)的伪随机float32值。</p>
<h3 id="func-Float64"><a href="#func-Float64" class="headerlink" title="func Float64"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#199">Float64</a></h3><pre class="line-numbers language-none"><code class="language-none">func Float64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个取值范围在[0.0, 1.0)的伪随机float64值。</p>
<h3 id="func-NormFloat64"><a href="#func-NormFloat64" class="headerlink" title="func NormFloat64"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#218">NormFloat64</a></h3><pre class="line-numbers language-none"><code class="language-none">func NormFloat64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个服从标准正态分布（标准差=1，期望=0）、取值范围在[-math.MaxFloat64, +math.MaxFloat64]的float64值</p>
<p>如果要生成不同的正态分布值，调用者可用如下代码调整输出：</p>
<pre class="line-numbers language-none"><code class="language-none">sample &#x3D; NormFloat64() * 标准差 + 期望<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="func-ExpFloat64"><a href="#func-ExpFloat64" class="headerlink" title="func ExpFloat64"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#228">ExpFloat64</a></h3><pre class="line-numbers language-none"><code class="language-none">func ExpFloat64() float64<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个服从标准指数分布（率参数=1，率参数是期望的倒数）、取值范围在(0, +math.MaxFloat64]的float64值</p>
<p>如要生成不同的指数分布值，调用者可用如下代码调整输出：</p>
<pre class="line-numbers language-none"><code class="language-none">sample &#x3D; ExpFloat64() &#x2F; 率参数<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="func-Perm"><a href="#func-Perm" class="headerlink" title="func Perm"></a>func <a href="https://github.com/golang/go/blob/master/src/math/rand/rand.go?name=release#207">Perm</a></h3><pre class="line-numbers language-none"><code class="language-none">func Perm(n int) []int<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回一个有n个元素的，[0,n)范围内整数的伪随机排列的切片。</p>
<h3 id="简单随机数示例"><a href="#简单随机数示例" class="headerlink" title="简单随机数示例"></a>简单随机数示例</h3><ol>
<li><strong>使用Seed种子确定状态执行Rand</strong></li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//该资源会在程序每次运行时都产生确定的序列。</span>
<span class="token comment">//如果需要每次运行产生不同的序列，应使用Seed函数进行初始化。</span>
<span class="token comment">//使用time.Now().Unix()随机Seed状态 不使用这个初始化Seed后，</span>
<span class="token comment">//data := rand.Int63n(1)</span>
<span class="token comment">//</span>
<span class="token comment">//fmt.Println(data) //每次输出都是1</span>
<span class="token comment">//每次输出都一样</span>
rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//同一秒执行的话 data会相同 可换为.UnixNano() 纳米时间戳</span>
<span class="token comment">//data为 [0-10)随机数 数值为int64型</span>
data <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li><strong>使用rand.New初始化状态执行Rand</strong></li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">rander <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NewSource</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	n1 <span class="token operator">:=</span> rander<span class="token punctuation">.</span><span class="token function">Int63n</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>标准库</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Go+Map写k-v数据库（SET-GET简单实现函数版）</title>
    <url>/2022/09/29/go18/</url>
    <content><![CDATA[<h3 id="通过实现一个简单的K–V存储数据库，学习Go语言（一）"><a href="#通过实现一个简单的K–V存储数据库，学习Go语言（一）" class="headerlink" title="通过实现一个简单的K–V存储数据库，学习Go语言（一）"></a>通过实现一个简单的K–V存储数据库，学习Go语言（一）</h3><h4 id="实现本地读写功能（使用map）"><a href="#实现本地读写功能（使用map）" class="headerlink" title="实现本地读写功能（使用map）"></a>实现本地读写功能（使用map）</h4><ol>
<li>使用结构体，实现myRedis类</li>
</ol>
<blockquote>
<p>注意 map 中值为 any 等同于 interface{} 本人使用<code>go 1.18</code>  any 为 interface{}  的自定义类型名称</p>
<p>使用 any 就可以存储任意类型</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> myRedis <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	mymap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>myRedis <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>myRedis<span class="token punctuation">&#123;</span>mymap<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<span id="more"></span>

<ol start="2">
<li>实现SET-GET功能</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">unc <span class="token punctuation">(</span>r <span class="token operator">*</span>myRedis<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> key <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		r<span class="token punctuation">.</span>mymap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"空值"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>myRedis<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>mymap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> v<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"无该元素"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="测试myRedis"><a href="#测试myRedis" class="headerlink" title="测试myRedis"></a>测试myRedis</h4><ol>
<li>单元测试</li>
</ol>
<blockquote>
<p>创建文件名为  <code>myMap_test.go</code>  即在原<code>myMap</code>后加上<code>_test</code>即可</p>
<p>函数名称改为Test【XXX】</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token comment">//样例测试</span>
<span class="token comment">//go test -v 样例测试命令</span>
<span class="token keyword">func</span> <span class="token function">TestMyRedis_Set</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	redis <span class="token operator">:=</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> i<span class="token punctuation">,</span> e <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span> <span class="token comment">//try a unit test on function</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Set函数测试没通过"</span><span class="token punctuation">)</span> <span class="token comment">// 如果不是如预期的那么就报错</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Set测试通过了"</span><span class="token punctuation">)</span> <span class="token comment">//记录一些你期望记录的信息</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">TestMyRedis_Get</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	redis <span class="token operator">:=</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	redis<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> v<span class="token punctuation">,</span> e <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span> <span class="token comment">//try a unit test on function</span>
		t<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Get函数测试没通过"</span><span class="token punctuation">)</span> <span class="token comment">// 如果不是如预期的那么就报错</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"Get测试通过了"</span><span class="token punctuation">)</span> <span class="token comment">//记录一些你期望记录的信息</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">"值为:"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行测试文件，输出：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D; RUN   TestMyRedis_Set
    mymap_test.go:12: Set测试通过了
--- PASS: TestMyRedis_Set (0.00s)
&#x3D;&#x3D;&#x3D; RUN   TestMyRedis_Get
    mymap_test.go:21: Get测试通过了
    mymap_test.go:22: 值为: 1
--- PASS: TestMyRedis_Get (0.00s)
PASS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>压力测试</li>
</ol>
<blockquote>
<p>函数名称改为Benchmark【XXX】</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkMyRedis_Set</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	redis <span class="token operator">:=</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span> <span class="token comment">//use b.N for looping</span>
		redis<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">BenchmarkMyRedis_Set2</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	b<span class="token punctuation">.</span><span class="token function">StopTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//调用该函数停止压力测试的时间计数</span>

	<span class="token comment">//做一些初始化的工作,例如读取文件数据,数据库连接之类的,</span>
	<span class="token comment">//这样这些时间不影响我们测试函数本身的性能</span>
	redis <span class="token operator">:=</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">StartTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//重新开始时间</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		redis<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">BenchmarkMyRedis_Get</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	b<span class="token punctuation">.</span><span class="token function">StopTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//调用该函数停止压力测试的时间计数</span>
	<span class="token comment">//做一些初始化的工作,例如读取文件数据,数据库连接之类的,</span>
	<span class="token comment">//这样这些时间不影响我们测试函数本身的性能</span>
	redis <span class="token operator">:=</span> <span class="token function">newRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	redis<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">StartTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//重新开始时间</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		redis<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行测试文件，输出：</p>
<pre class="line-numbers language-none"><code class="language-none">goos: windows
goarch: amd64
pkg: 7days_test&#x2F;key-value
cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
BenchmarkMyRedis_Set
BenchmarkMyRedis_Set-12         130041237                8.598 ns&#x2F;op
BenchmarkMyRedis_Set2
BenchmarkMyRedis_Set2-12        138570001                8.876 ns&#x2F;op
BenchmarkMyRedis_Get
BenchmarkMyRedis_Get-12         327336081                3.726 ns&#x2F;op
PASS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>327336081为运行次数       3.726 ns/op为运行速度</p>
<p>以上说明GET读性能远大于写性能</p>
<p><strong>未完待续~</strong></p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Go+Map写k-v数据库（SET-GET简单实现命令行版）</title>
    <url>/2022/09/30/go19/</url>
    <content><![CDATA[<h3 id="通过实现一个简单的K–V存储数据库，学习Go语言（二）"><a href="#通过实现一个简单的K–V存储数据库，学习Go语言（二）" class="headerlink" title="通过实现一个简单的K–V存储数据库，学习Go语言（二）"></a>通过实现一个简单的K–V存储数据库，学习Go语言（二）</h3><h4 id="实现本地增删改查功能（使用map）"><a href="#实现本地增删改查功能（使用map）" class="headerlink" title="实现本地增删改查功能（使用map）"></a>实现本地增删改查功能（使用map）</h4><p>命令为 <code>SET</code> <code>DELETE</code> <code>UPDATE</code> <code>GET</code> <code>SHOW</code> </p>
<ol>
<li>添加新元素</li>
<li>基于key删除已有的元素</li>
<li>修改key对应的value</li>
<li>给定key查找对应value</li>
<li>查找所有key，value</li>
</ol>
<span id="more"></span>

<h5 id="定义全局map"><a href="#定义全局map" class="headerlink" title="定义全局map"></a>定义全局map</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> DATA <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="实现增删改查"><a href="#实现增删改查" class="headerlink" title="实现增删改查"></a>实现增删改查</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token comment">//fmt.Println("set successful!")</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: existence of this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">GET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">DELETE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>DATA<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token comment">//fmt.Println("delete successful!")</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">UPDATE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token comment">//fmt.Println("update successful!")</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> DATA <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="命令行实现"><a href="#命令行实现" class="headerlink" title="命令行实现"></a>命令行实现</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cmd <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	s <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	<span class="token comment">//不断读入命令</span>
	<span class="token keyword">for</span> s<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		text <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//分割命令与参数</span>
		cmd <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
		<span class="token comment">//strings.TrimSpace()</span>
		<span class="token comment">//strings.Fields()</span>
		<span class="token comment">//判断对应命令</span>
		<span class="token keyword">switch</span> cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token string">"SET"</span><span class="token punctuation">:</span>
			<span class="token function">SET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
			<span class="token function">GET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"SHOW"</span><span class="token punctuation">:</span>
			<span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span>
			<span class="token function">DELETE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"UPDATE"</span><span class="token punctuation">:</span>
			<span class="token function">UPDATE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Unknown command - please try again!"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="实现结果"><a href="#实现结果" class="headerlink" title="实现结果"></a>实现结果</h4><pre class="line-numbers language-none"><code class="language-none">SET test1 2
GET test1
2
GET test22
error: not found this key!
SHOW
test:1
test1:2
UPDATE test 111
GET test
111
SHOW
test:111
test1:2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>下一步将 key-value 进行持久化存储和实现TCP/IP接口访问</strong></p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么代码中实例化结构体时大多要返回结构体指针 而不是结构体值</title>
    <url>/2022/08/17/go2/</url>
    <content><![CDATA[<p>在学习 go 语言项目时，遇到这样一个问题：</p>
<p>通过struct结构体作为一个model，数据绑定等操作都是返回一个结构体指针，那么返回一个结构体变量，或者返回一个结构体指针，他们的区别是什么？</p>
<p>因为二者都可以让我们生成我们所需要的结构体，<strong>那为什么还要去使用返回结构体指针呢</strong>？</p>
<p>对于此疑问，我做了如下实验</p>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// TableFile : 文件表结构体</span>
<span class="token keyword">type</span> TableFile <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	FileHash <span class="token builtin">string</span>
	FileName <span class="token builtin">string</span>
	FileSize <span class="token builtin">string</span>
	FileAddr <span class="token builtin">string</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// GetFileMeta1  从mysql获取文件元信息</span>
<span class="token keyword">func</span> <span class="token function">GetFileMeta1</span><span class="token punctuation">(</span>filehash1 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>TableFile <span class="token punctuation">&#123;</span>

	tfile1 <span class="token operator">:=</span> TableFile<span class="token punctuation">&#123;</span>FileHash<span class="token punctuation">:</span> filehash1<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta1函数内：%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tfile1<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>tfile1
<span class="token punctuation">&#125;</span>

<span class="token comment">// GetFileMeta2  从mysql获取文件元信息</span>
<span class="token keyword">func</span> <span class="token function">GetFileMeta2</span><span class="token punctuation">(</span>filehash1 <span class="token builtin">string</span><span class="token punctuation">)</span> TableFile <span class="token punctuation">&#123;</span>

	tfile2 <span class="token operator">:=</span> TableFile<span class="token punctuation">&#123;</span>FileHash<span class="token punctuation">:</span> filehash1<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta2函数内：%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tfile2<span class="token punctuation">)</span>
	<span class="token keyword">return</span> tfile2
<span class="token punctuation">&#125;</span>


<span class="token comment">// GetFileMeta3 从mysql获取文件元信息</span>
<span class="token keyword">func</span> <span class="token function">GetFileMeta3</span><span class="token punctuation">(</span>filehash1 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tfile3 TableFile<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	tfile3 <span class="token operator">=</span> TableFile<span class="token punctuation">&#123;</span>FileHash<span class="token punctuation">:</span> filehash1<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta3函数内：%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tfile3<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t1 <span class="token operator">:=</span> <span class="token function">GetFileMeta1</span><span class="token punctuation">(</span><span class="token string">"1111"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta1  函数外%p\n"</span><span class="token punctuation">,</span> t1<span class="token punctuation">)</span>
	t2 <span class="token operator">:=</span> <span class="token function">GetFileMeta2</span><span class="token punctuation">(</span><span class="token string">"1111"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta2  函数外%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t2<span class="token punctuation">)</span>
	t3 <span class="token operator">:=</span> <span class="token function">GetFileMeta3</span><span class="token punctuation">(</span><span class="token string">"1111"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"GetFileMeta3  函数外%p\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>t3<span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">//GetFileMeta1函数内：0xc00005a040</span>
<span class="token comment">//GetFileMeta1  函数外0xc00005a040</span>

<span class="token comment">//GetFileMeta2函数内：0xc00005a0c0</span>
<span class="token comment">//GetFileMeta2  函数外0xc00005a080</span>

<span class="token comment">//GetFileMeta3函数内：0xc00005a140</span>
<span class="token comment">//GetFileMeta3  函数外0xc00005a100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里可以发现：</p>
<ul>
<li>使用指针结构体只分配了一次内存</li>
<li>使用结构体值却分配了两次</li>
</ul>
<p>由于go是值拷贝模式，指针拷贝地址，没有分配多余内存；值拷贝数值，新的变量会重新分配地址给数值。</p>
<p>这一点了解了，可是我仍然不知道指针的性能提升在那里，虽然指针只分配了一次地址空间，可是该空间会分配在堆上发生内存逃逸，影响程序性能；</p>
<p>值空间虽然分配了两次空间，但函数内变量空间分配在栈上，函数结束，系统内核会自动销毁，不影响性能，？难道是多次分配调度内存空间，影响更大？</p>
<p>返回结构体值与结构体指针性能问题:</p>
<p><strong>传值 VS 传指针</strong>： 传值会拷贝整个对象，而传指针只会拷贝指针地址，指向的对象是同一个。传指针可以减少值的拷贝，但是会导致内存分配逃逸到堆中，增加垃圾回收(GC)的负担。在对象频繁创建和删除的场景下，传递指针导致的 GC 开销可能会严重影响性能。</p>
<p> 一般情况下，对于需要修改原对象值，或占用内存比较大的结构体，选择传指针。对于只读的占用内存较小的结构体，直接传值能够获得更好的性能</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>指针</tag>
        <tag>结构体</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Go+Map写k-v数据库（SET-GET简单实现磁盘存储版）</title>
    <url>/2022/09/30/go20/</url>
    <content><![CDATA[<h3 id="通过实现一个简单的K–V存储数据库，学习Go语言（三）"><a href="#通过实现一个简单的K–V存储数据库，学习Go语言（三）" class="headerlink" title="通过实现一个简单的K–V存储数据库，学习Go语言（三）"></a>通过实现一个简单的K–V存储数据库，学习Go语言（三）</h3><blockquote>
<p>作为数据库我们需要将键值存储的数据保存在磁盘上，以及如何在下一次启动应用程序时将其加载到内存。</p>
<p>我们准备创建两个新函数，<code>save()</code>保存数据到磁盘，<code>load()</code>从磁盘加载数据。</p>
<p>将数据转换为字节流的过程称为序列化。读取数据文件并将其转换为对象的过程称为反序列化。</p>
<p>encoding/gob<code>标准</code>Go包将用于程序中。它将有助于序列化和反序列化过程。</p>
<p><code>encoding/gob</code>包使用<code>gob</code>格式存储其数据。这种格式的官方名称是流编码。</p>
<p><code>gob</code>格式的好处是，<code>Go</code>完成了所有的繁琐工作，因此你不必担心编码和解码阶段。</p>
</blockquote>
<span id="more"></span>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bufio"</span>
	<span class="token string">"encoding/gob"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"os"</span>
	<span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> DATA <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> DATAFILE <span class="token operator">=</span> <span class="token string">"dataFile.gob"</span>

<span class="token comment">//myRedis基础功能</span>

<span class="token keyword">func</span> <span class="token function">SET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token comment">//fmt.Println("set successful!")</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: existence of this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">GET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">DELETE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>DATA<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token comment">//fmt.Println("delete successful!")</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">UPDATE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"error: not found this key!"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token comment">//fmt.Println("update successful!")</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> DATA <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//数据持久化</span>

<span class="token comment">//保存数据在磁盘上</span>
<span class="token keyword">func</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//去除原数据文件，保存为新数据文件</span>
	err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	saveFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cannot create"</span><span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> saveFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//序列化存储数据到文件</span>
	encoder <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>saveFile<span class="token punctuation">)</span>
	<span class="token comment">//转码数据</span>
	err <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>DATA<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>DATA<span class="token punctuation">,</span> saveFile<span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cannot save to"</span><span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//启动应用时，加载数据</span>

<span class="token keyword">func</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	loadFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> loadFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Empty key/value store!"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token comment">//反序列化读取文件</span>
	decoder <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>loadFile<span class="token punctuation">)</span>
	<span class="token comment">//解码数据</span>
	decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DATA<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//load File</span>
	err <span class="token operator">:=</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	cmd <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	s <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	<span class="token keyword">for</span> s<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		text <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		cmd <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
		<span class="token comment">//strings.TrimSpace()</span>
		<span class="token comment">//strings.Fields()</span>
		<span class="token keyword">switch</span> cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token string">"SET"</span><span class="token punctuation">:</span>
			<span class="token function">SET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
			<span class="token function">GET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"SHOW"</span><span class="token punctuation">:</span>
			<span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span>
			<span class="token function">DELETE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"UPDATE"</span><span class="token punctuation">:</span>
			<span class="token function">UPDATE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token string">"STOP"</span><span class="token punctuation">:</span>
			err <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Unknown command - please try again!"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

	<span class="token punctuation">&#125;</span>

	<span class="token comment">//end to save file</span>
	err <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Go+Map写k-v数据库（SET-GET简单实现TCP版）</title>
    <url>/2022/10/01/go21/</url>
    <content><![CDATA[<h3 id="通过实现一个简单的K–V存储数据库，学习Go语言（四）"><a href="#通过实现一个简单的K–V存储数据库，学习Go语言（四）" class="headerlink" title="通过实现一个简单的K–V存储数据库，学习Go语言（四）"></a>通过实现一个简单的K–V存储数据库，学习Go语言（四）</h3><blockquote>
<p>为了能够和网络中的 key-value 存储交互，我们创建自定义的 TCP 协议。</p>
<p>您将需要为 key-value 存储的每一个函数定义关键字。</p>
<p>为简单起见，每个关键字都跟着相关数据。大多数命令的结果将是成功或失败消息</p>
</blockquote>
<span id="more"></span>

<h4 id="通过TCP连接，实现myRedis客户端与服务端"><a href="#通过TCP连接，实现myRedis客户端与服务端" class="headerlink" title="通过TCP连接，实现myRedis客户端与服务端"></a>通过TCP连接，实现<code>myRedis</code>客户端与服务端</h4><ul>
<li><strong>服务端</strong></li>
</ul>
<blockquote>
<p>目前存在小BUG，待优化——如客户端断开重连问题等</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bufio"</span>
	<span class="token string">"encoding/gob"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
	<span class="token string">"os"</span>
	<span class="token string">"strings"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> DATA <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">var</span> DATAFILE <span class="token operator">=</span> <span class="token string">"dataFile.gob"</span>

<span class="token comment">//myRedis基础功能</span>
<span class="token comment">//启动应用时，加载数据</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	err <span class="token operator">:=</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	loadFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> loadFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Empty key/value store!"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//反序列化读取文件</span>
	decoder <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>loadFile<span class="token punctuation">)</span>
	<span class="token comment">//解码数据</span>
	decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DATA<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"初始化："</span><span class="token punctuation">,</span> DATA<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">SET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
		<span class="token keyword">return</span> <span class="token string">""</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token string">"error: existence of this key!"</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">GET</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token string">"error: not found this key!"</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">DELETE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token string">"error: not found this key!"</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>DATA<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">UPDATE</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token string">"error: not found this key!"</span>
	<span class="token punctuation">&#125;</span>
	DATA<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
	<span class="token keyword">return</span> <span class="token string">""</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	str <span class="token operator">:=</span> <span class="token string">""</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> DATA <span class="token punctuation">&#123;</span>
		str <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s "</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> str
<span class="token punctuation">&#125;</span>

<span class="token comment">//数据持久化</span>

<span class="token comment">//保存数据在磁盘上</span>
<span class="token keyword">func</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//去除原数据文件，保存为新数据文件</span>
	err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	saveFile<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cannot create"</span><span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> saveFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//序列化存储数据到文件</span>
	encoder <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>saveFile<span class="token punctuation">)</span>
	<span class="token comment">//转码数据</span>
	err <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>DATA<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>DATA<span class="token punctuation">,</span> saveFile<span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Cannot save to"</span><span class="token punctuation">,</span> DATAFILE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">myRedis</span><span class="token punctuation">(</span>text <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	cmd <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	cmd <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> cmd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token string">"SET"</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> <span class="token function">SET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> s
	<span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> <span class="token function">GET</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> s
	<span class="token keyword">case</span> <span class="token string">"SHOW"</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> <span class="token function">SHOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> s
	<span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> <span class="token function">DELETE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> s
	<span class="token keyword">case</span> <span class="token string">"UPDATE"</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> <span class="token function">UPDATE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cmd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> s
	<span class="token keyword">case</span> <span class="token string">"STOP"</span><span class="token punctuation">:</span>
		err <span class="token operator">:=</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">"Unknown command - please try again!"</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token string">"sucess"</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//net.Listen() 函数用于监听连接,如果第二个参数不包含 IP 地址，只有端口号的话，net.Listen()</span>
	<span class="token comment">//将监听本地系统上所有可用的 IP 地址。</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"localhost:5000"</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"myRedis localhost:5000 启动..."</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"=客户端连接成功啦！"</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//获取客户端发来的消息</span>
		data<span class="token punctuation">,</span> err <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		sendMsg <span class="token operator">:=</span> <span class="token function">myRedis</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"接受客户端消息为："</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token comment">//发送给客户端</span>
		<span class="token keyword">if</span> sendMsg <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>sendMsg <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>客户端</strong></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bufio"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"net"</span>
	<span class="token string">"os"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//连接服务端</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"localhost:5000"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//通过io输入消息给服务端</span>
		reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span>
		<span class="token comment">//获取每一行输入</span>
		text<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token comment">//标准格式，通过conn数据发送</span>
		<span class="token comment">//fmt.Fprintf(conn, text)</span>
		conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">//读取接受消息</span>
		acceptMsg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>acceptMsg<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h4><ul>
<li>客户端输入</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&gt;&gt; SHOW
nil
   
&gt;&gt; SET test 1
sucess
      
&gt;&gt; SET test1 2
sucess
      
&gt;&gt; SET test2 3 
sucess

&gt;&gt; SHOW
test1:2 test2:3 test:1 
&#x2F;&#x2F;保存
&gt;&gt; STOP
sucess

&#x2F;&#x2F;手动断开连接，重启
&gt;&gt; SHOW
test:1 test1:2 test2:3 

&gt;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>服务端输出</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">myRedis localhost:5000 启动...
客户端连接成功啦！
接受客户端消息为： SHOW
接受客户端消息为： SET test 1
接受客户端消息为： SET test1 2
接受客户端消息为： SET test2 3
接受客户端消息为： SHOW
&#x2F;&#x2F;保存
map[test:1 test1:2 test2:3] &amp;&#123;0xc00010f180&#125; dataFile.gob
接受客户端消息为： STOP

&#x2F;&#x2F;手动断开连接，重启
myRedis localhost:5000 启动...
客户端连接成功啦！
接受客户端消息为： SHOW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础2——map相关</title>
    <url>/2022/08/18/go3/</url>
    <content><![CDATA[<h5 id="map-中删除一个-key，它的内存会释放么？"><a href="#map-中删除一个-key，它的内存会释放么？" class="headerlink" title="map 中删除一个 key，它的内存会释放么？"></a>map 中删除一个 key，它的内存会释放么？</h5><p>两种情况：</p>
<ol>
<li>value元素为值类型时，不会释放内存</li>
<li>value元素为引用类型时，会释放内存，释放该元素类型所占内存</li>
</ol>
<p>当map置为nil时，内存被回收 [（go垃圾回收)](<a href="https://www.bilibili.com/video/BV1B34y1h73h?spm_id_from=333.337.search-card.all.click">[Go面试]Go GC实现原理?_哔哩哔哩_bilibili</a>)</p>
<span id="more"></span>

<h5 id="map-使用注意的点，是否并发安全？"><a href="#map-使用注意的点，是否并发安全？" class="headerlink" title="map 使用注意的点，是否并发安全？"></a>map 使用注意的点，是否并发安全？</h5><ol>
<li>一定要先初始化，否则panic</li>
<li>map类型(引用类型)是容易发生并发访问问题的。不注意就容易发生程序运行时并发读写导致的panic。 Go语言内建的map对象不是线程安全的，并发读写的时候运行时会有检查，遇到并发问题就会导致panic。</li>
</ol>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础3——GC相关</title>
    <url>/2022/08/18/go4/</url>
    <content><![CDATA[<h5 id="什么是GC"><a href="#什么是GC" class="headerlink" title="什么是GC"></a>什么是GC</h5><p>垃圾回收就是对程序中不再使用的内存资源进行自动回收的操作。</p>
<p>堆<a href="https://so.csdn.net/so/search?q=%E5%86%85%E5%AD%98&spm=1001.2101.3001.7020">内存</a>上分配的数据对象，不会再使用时，不会自动释放内存，就变成垃圾，在程序的运行过程中，如果不能及时清理，会导致越来越多的内存空间被浪费，导致系统性能下降。</p>
<p>因此需要<strong>内存回收</strong>，内存回收分为两种方式:</p>
<ol>
<li><p>手动释放占用内存空间</p>
<p>可能会出现的问题：<br><strong>悬挂指针：</strong> 释放的早了，后续对数据的访问就会出错，因为对应的内存空间可能已经清空，重新分配，甚至是归还给操作系统了。<br><strong>内存泄漏：</strong> 如果忘了释放，一直占用内存，导致内存泄漏。</p>
</li>
<li><p>自动内存回收</p>
<p>程序自动检测对象决定是否要回收其内存。</p>
<p><strong>核心思想：</strong>程序中用得到的数据，一定是可以从栈或数据段这些根节点追踪得到的数据，追踪不到的数据，肯定用不到，也就是垃圾。</p>
<span id="more"></span></li>
</ol>
<h5 id="go-gc-是怎么实现的？"><a href="#go-gc-是怎么实现的？" class="headerlink" title="go gc 是怎么实现的？"></a>go gc 是怎么实现的？</h5><hr>
<p>一次完整的垃圾回收会分为四个阶段，分别是标记准备、标记开始、标记终止、清理：</p>
<ol>
<li><strong>标记准备（Mark Setup）</strong>：打开写屏障（Write Barrier），需 STW（stop the world)</li>
<li><strong>标记开始（Marking）</strong>：使用三色标记法并发标记 ，与用户程序并发执行</li>
<li><strong>标记终止（Mark Termination</strong>）：对触发写屏障的对象进行重新扫描标记，关闭写屏障（Write Barrier），需 STW（stop the world)</li>
<li><strong>清理（Sweeping）</strong>：将需要回收的内存归还到堆中，将过多的内存归还给操作系统，与用户程序并发执行</li>
</ol>
<hr>
<ol>
<li><p><strong>GC机制随着golang版本变化如何变化的？</strong></p>
<p>go 1.3 之前采用<strong>标记清除法</strong>，需要<strong>STW</strong><br>go 1.5 采用<strong>三色标记法</strong>，插入<strong>写屏障机制</strong>（只在堆内存中生效），最后仍需对栈内存进行STW<br>go 1.8 采用混合写屏障机制**，屏障限制只在堆内存中生效。避免了最后节点对栈进行STW的问题，提升了GC效率</p>
</li>
<li><p>一个概念：<strong>STW</strong>：stop the word，指程序执行过程中，中断暂停程序逻辑，专门去进行<a href="https://so.csdn.net/so/search?q=%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6&spm=1001.2101.3001.7020">垃圾回收</a>。（STW<strong>目的是为了防止GC扫描时内存变化引起的混乱</strong>）</p>
</li>
<li><p><strong>标记清除法</strong></p>
<p>从根变量开始遍历所有引用的对象，标记引用的对象，没有被标记的进行回收。</p>
<ul>
<li>开启STW，</li>
<li>从根节点出发，标记所有可达对象 </li>
<li>停止STW，然后回收所有未标记的对象。</li>
<li>优点：解决了引用计数的缺点。</li>
<li>缺点：需要 STW，暂时停掉程序运行。</li>
</ul>
</li>
<li><p><strong>三色标记法【改进的标记清除法】+写屏障机制的流程</strong></p>
</li>
</ol>
<p>三色标记法是对标记阶段的改进，原理如下：</p>
<ul>
<li>初始状态所有对象都是白色。</li>
<li>从root根出发扫描所有根对象（下图a,b），将他们引用的对象标记为灰色（图中A，B）</li>
</ul>
<blockquote>
<p>那么什么是root呢？ 看了很多文章都没解释这这个概念，在这儿说明下：root区域主要是程序运行到当前时刻的栈、寄存器和全局变量。</p>
<p><img src="/2022/08/18/go4/image-20220802113108020.png" alt="image-20220802113108020"></p>
</blockquote>
<ul>
<li><p>遍历灰色对象，将灰色对象引用的对象由白色  也变成灰色对象，然后将遍历过的灰色对象变成黑色对象。</p>
</li>
<li><p>循环步骤3，直到灰色对象全部变黑色。重复以上操作</p>
<blockquote>
<p>其中通过<strong>写屏障</strong>(write-barrier)【<strong>写屏障就是让goroutine与GC同时运行的手段，大大减少STW的时间</strong>，开启后指针传递时会把指针标记，本轮不回收，下轮GC时回收】检测对象有变化；还有一个<strong>辅助GC</strong>(mutator assist)机制【<strong>为防止内存分配过快，GC过程中，辅助GC线程并发运行，协助GC做一部分工作</strong>，先做一部分标记工作】，</p>
</blockquote>
</li>
<li><p>收集所有白色对象（垃圾）。</p>
</li>
</ul>
<p><strong>插入写屏障</strong></p>
<p>对象被引用时触发的机制（只在堆内存中生效）：赋值器这一行为通知给并发执行的回收器，被引用的对象标记为灰色</p>
<p>缺点：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活</p>
<p><strong>删除写屏障</strong></p>
<p>对象被删除时触发的机制（只在堆内存中生效）：赋值器将这一行为通知给并发执行的回收器，被删除的对象，如果自身为灰色或者白色，那么标记为灰色</p>
<p>缺点：一个对象的引用被删除后，即使没有其他存活的对象引用它，它仍然会活到下一轮，会产生很大冗余扫描成本，且降低了回收精度</p>
<p><strong>混合写屏障</strong></p>
<p>GC没有混合写屏障前，一直是插入写屏障；混合写屏障是插入写屏障 + 删除写屏障，写屏障只应用在堆上应用，栈上不启用（栈上启用成本很高）</p>
<ul>
<li>GC开始将栈上的对象全部扫描并标记为黑色。</li>
<li>GC期间，任何在栈上创建的新对象，均为黑色。</li>
<li>被删除的对象标记为灰色。</li>
<li>被添加的对象标记为灰色。</li>
</ul>
<h5 id="GC-的触发时机"><a href="#GC-的触发时机" class="headerlink" title="GC 的触发时机"></a>GC 的触发时机</h5><p><strong>主动触发</strong>：</p>
<ul>
<li>调用 runtime.GC() 方法，触发 GC</li>
</ul>
<p><strong>被动触发：</strong></p>
<ul>
<li>定时触发，该触发条件由 <code>runtime.forcegcperiod</code> 变量控制，默认为 2 分 钟。当超过两分钟没有产生任何 GC 时，触发 GC</li>
<li>根据内存分配阈值触发，该触发条件由环境变量GOGC控制，默认值为100（100%），当前堆内存占用是上次GC结束后占用内存的2倍时，触发GC</li>
</ul>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>GC垃圾回收</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础4——Channel相关</title>
    <url>/2022/08/18/go5/</url>
    <content><![CDATA[<h5 id="channel-是否线程安全？锁用在什么地方？"><a href="#channel-是否线程安全？锁用在什么地方？" class="headerlink" title="channel 是否线程安全？锁用在什么地方？"></a>channel 是否线程安全？锁用在什么地方？</h5><blockquote>
<p>Golang的Channel,发送一个数据到Channel 和 从Channel接收一个数据都是原子性的。</p>
<p>如果把线程安全定义为允许多个goroutine同时去读写，那么golang 的channel 是线程安全的，因为channel底层数据结构中是带有lock的，不需要在并发读写同一个channe时再加锁。</p>
<p>而且Go的设计思想就是：不要通过共享内存来通信，而是通过通信来共享内存，前者就是传统的加锁（共享内存通信），后者就是Channel。</p>
<p>也就是说，设计Channel的主要目的就是在多任务间传递数据的，这当然是安全的</p>
</blockquote>
<h5 id="go-channel-的底层实现原理-（数据结构）"><a href="#go-channel-的底层实现原理-（数据结构）" class="headerlink" title="go channel 的底层实现原理 （数据结构）"></a>go channel 的底层实现原理 （数据结构）</h5><p>总结hchan结构体的主要组成部分有四个：</p>
<ul>
<li>用来保存goroutine之间传递数据的循环数组：buf</li>
<li>用来记录此循环数组当前发送或接收数据的下标值：sendx（发送队列）和recvx（接受队列）</li>
<li>用于保存向该chan发送和从该chan接收数据被阻塞的goroutine队列： sendq 和 recvq</li>
<li>保证channel写入和读取数据时线程安全的锁：lock</li>
</ul>
<span id="more"></span>

<h5 id="go-channel为什么设计成线程安全？"><a href="#go-channel为什么设计成线程安全？" class="headerlink" title="go channel为什么设计成线程安全？"></a>go channel为什么设计成线程安全？</h5><p>不同协程通过channel进行通信，本身的使用场景就是多线程，为了保证数据的一致性，必须实现线程安全</p>
<h5 id="如何实现线程安全的？"><a href="#如何实现线程安全的？" class="headerlink" title="如何实现线程安全的？"></a>如何实现线程安全的？</h5><p>channel的底层实现中，hchan结构体中采用Mutex（互斥）锁来保证数据读写安全。在对循环数组buf中的数据进行入队和出队操作时，必须先获取互斥锁，才能操作channel数据</p>
<h5 id="nil、关闭的-channel、有数据的-channel，再进行读、写、关闭会怎么样？"><a href="#nil、关闭的-channel、有数据的-channel，再进行读、写、关闭会怎么样？" class="headerlink" title="nil、关闭的 channel、有数据的 channel，再进行读、写、关闭会怎么样？"></a>nil、关闭的 channel、有数据的 channel，再进行读、写、关闭会怎么样？</h5><ol>
<li>读写值 nil 管道会永久阻塞 </li>
<li>关闭的管道读数据仍然可以读数据 </li>
<li>往关闭的管道写数据会 panic</li>
<li>关闭为 nil 的管道会 panic </li>
<li>关闭已经关闭的管道 panic</li>
</ol>
<p><strong>总结：</strong>对于一个已初始化，但并未关闭的通道来说，收发操作一定不会引发 panic。但是通道一旦关闭，再对它进行发送操作，就会引发 panic。如果我们试图关闭一个已经关闭了的通道，也会引发 panic。</p>
<p><strong>使用场景：</strong> 消息传递、消息过滤，信号广播，事件订阅与广播，请求、响应转发，任务分发，结果汇总，并发控制，限流，同步与异步</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>Channel</tag>
      </tags>
  </entry>
  <entry>
    <title>逃逸分析能做什么？如何进行逃逸分析？</title>
    <url>/2022/08/20/go7/</url>
    <content><![CDATA[<blockquote>
<p>（上级垃圾回收 问题逻辑- 垃圾回收-&gt;逃逸分析-&gt;内存逃逸）</p>
</blockquote>
<blockquote>
<p>逃逸分析是什么：编译器决定内存分配位置的方式，就称之为逃逸分析(escape analysis)。逃逸分析由编译器完成，作用于编译阶段。</p>
<p>逃逸分析能做什么：可以了解程序哪些内存在栈上，哪些在堆上，从而优化减少垃圾回收提升性能。</p>
<p>如何进行逃逸分析：go语言可以使用<strong>go build -gcflags ‘-m -N -l’</strong>  test.go 的方式 查看编译结果中的逃逸情况 在堆上（heap）的就发生了逃逸</p>
</blockquote>
<p> <strong>必然不会发生逃逸的情况：</strong></p>
<ol>
<li><p>指针被没有发生逃逸的变量引用</p>
</li>
<li><p>仅仅在函数被对变量进行取地址操作，没有将指针传出</p>
<span id="more"></span></li>
</ol>
<p> <strong>一定逃逸</strong></p>
<ol>
<li>构造函数new/make 返回的指针变量一定逃逸</li>
<li>被已经逃逸指针变量引用指针，一定发生逃逸</li>
<li>指针类型是slice，map,chan 引用指针一定发生逃逸</li>
</ol>
<p><strong>Maybe 逃逸</strong><br> 将指针作为入参传给别的函数，这里看指针在被传入函数的处理过程，如果发生上边三种情况会逃逸，否则不会</p>
<p><strong>传值 VS 传指针</strong>： 传值会拷贝整个对象，而传指针只会拷贝指针地址，指向的对象是同一个。传指针可以减少值的拷贝，但是会导致内存分配逃逸到堆中，增加垃圾回收(GC)的负担。在对象频繁创建和删除的场景下，传递指针导致的 GC 开销可能会严重影响性能。</p>
<p> 一般情况下，对于需要修改原对象值，或占用内存比较大的结构体，选择传指针。对于只读的占用内存较小的结构体，直接传值能够获得更好的性能</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>内存逃逸</tag>
      </tags>
  </entry>
  <entry>
    <title>goroutine(协程)和线程是什么关系，goroutine是如何调度的？</title>
    <url>/2022/08/20/go6/</url>
    <content><![CDATA[<blockquote>
<p>（上级问题并发  问题逻辑-  并发机制-&gt;GMP-&gt;goroutine调度）</p>
</blockquote>
<h4 id="goroutine-协程-和线程"><a href="#goroutine-协程-和线程" class="headerlink" title="goroutine(协程)和线程"></a>goroutine(协程)和线程</h4><p>说线程之前，我们先说进程和线程的关系，</p>
<p>首先线程是进程的执行体，拥有一个执行入口，以及进程虚拟地址空间中分配的栈—包括用户栈和内核栈，操作系统会记录线程控制信息，</p>
<p>而线程会在获得cpu时间片信息后执行 ，cpu中栈指针、指令指针等寄存器都到切换到对应的线程；</p>
<p>而协程就是线程创建的执行体，其控制信息由线程记录，由于用户程序不能操作内核空间，所以只能给协程分配用户栈，而操作系统对这个信息一无所知。</p>
<p><strong>总结：</strong>协程是一种”用户态线程”。</p>
<h4 id="goroutine如何调度"><a href="#goroutine如何调度" class="headerlink" title="goroutine如何调度"></a>goroutine如何调度</h4><p>说到goroutine的调度就不得不提MPG（GMP）模型</p>
<ul>
<li>M: 线程</li>
<li>P: 执行go协程运行所必需的资源，关联本地可运行G的队列</li>
<li>G: go协程</li>
</ul>
<span id="more"></span>

<h4 id="G，M，P的个数"><a href="#G，M，P的个数" class="headerlink" title="G，M，P的个数"></a>G，M，P的个数</h4><ul>
<li>M 的数据默认启动的时候是 10000，内核很难支持这么多线程数，所以整个限制客户忽略，M 一般不做设置，设置好 P，M 一般都是要大于 P。</li>
<li>P 的数量一般建议是逻辑 CPU 数量的 2 倍。——使用<strong>runtime.GOMAXPROCS()</strong> 变量数一般是cpu核数的2倍，具体看性能分析。</li>
<li>G 的个数理论上是无限制的，但是受内存限制。</li>
</ul>
<p>一开始go创建时只有MG，多个M分担多个G的执行任务时（想象整体G是一个全局队列，多个M执行G时），就会因为频繁 加锁解锁（不能让其他线程执行到同一个G）而发生等待，影响并发性能。所以，使用P，p有一个本地队列，这样只要M关联到P，就可以直接运行队列中待执行的G，不用每次从全局队列中争抢了。</p>
<p>（注意一个问题：程序中主进程结束不管协程有没有运行完，都会结束，所以一般使用wg <strong>sync.WaitGroup</strong>  wg.Add()  go func(){    wg.Done}  wg.Wait()）</p>
<p><strong>总结GMP调度流程：</strong></p>
<ul>
<li>线程M想运行任务就需得获取 P，即与P关联。</li>
<li>然从 P 的本地队列(LRQ)获取 G</li>
<li>若LRQ中没有可运行的G，M 会尝试从全局队列(GRQ)拿一批G放到P的本地队列，</li>
<li>若全局队列也未找到可运行的G时候，M会随机从其他 P 的本地队列偷一半放到自己 P 的本地队列。</li>
<li>拿到可运行的G之后，M 运行 G，G 执行之后，M 会从 P 获取下一个 G，不断重复下去。</li>
</ul>
<h4 id="Go如何有效控制Goroutine并发数量"><a href="#Go如何有效控制Goroutine并发数量" class="headerlink" title="Go如何有效控制Goroutine并发数量"></a>Go如何有效控制Goroutine并发数量</h4>]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
        <tag>goroutine</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础5--切片与数组相关</title>
    <url>/2022/08/22/go8/</url>
    <content><![CDATA[<h4 id="slice-和-array的区别？（下级问题-gt-slice底层与扩容机制）"><a href="#slice-和-array的区别？（下级问题-gt-slice底层与扩容机制）" class="headerlink" title="slice 和 array的区别？（下级问题-&gt;slice底层与扩容机制）"></a>slice 和 array的区别？（下级问题-&gt;slice底层与扩容机制）</h4><ul>
<li>数组的零值是元素类型的零值，切片的零值是 nil；</li>
<li>数组是固定长度，切片是可变长度；</li>
<li>数组是值类型，切片是引用类型。</li>
</ul>
<h4 id="slice的底层实现"><a href="#slice的底层实现" class="headerlink" title="slice的底层实现"></a>slice的底层实现</h4><blockquote>
<p>slice 底层 是有 3 个字段的数据结构分为：</p>
<ul>
<li>array 数组</li>
<li>len 长度</li>
<li>cap 容量</li>
</ul>
</blockquote>
<p>指针指向数组的第一个该 slice 可访问的元素，这个元素并不一定是底层数组的第一个元素，长度是指 slice 中元素的个数，它不能超过 slice 的容量。</p>
<p>容量的大小通常是从 slice 底层数组的元素个数，什么意思呢举例：</p>
<p>arr：=[]int{1,2,3,4} slice:=arr[1:3] —（即：{2，3，4}） slice的长度为3 容量为4（{1，2，3，4}为底层数组）</p>
<p>Go 的内置函数 len 和 cap 用来返回 slice 的长度和容量。</p>
<span id="more"></span>

<h4 id="slice扩容机制"><a href="#slice扩容机制" class="headerlink" title="slice扩容机制"></a>slice扩容机制</h4><p>容量1024前 每次扩容2倍，之后扩容1.25倍，一直到超过元素数量或者相等位置。</p>
<p>所以对于数量太大的切片来说，扩容很耗性能，因为每次扩容，切片都会重新分配内存空间，并将原切片的值复制给新切片，原切片被垃圾回收。</p>
<p>如果知道容量的话，一开始指定生成大容量切片较好。使用make语句</p>
<h4 id="byte-和-string-的区别（深层次问题-gt-数组与切片的区别）"><a href="#byte-和-string-的区别（深层次问题-gt-数组与切片的区别）" class="headerlink" title="[]byte{}和 string 的区别（深层次问题-&gt;数组与切片的区别）"></a>[]byte{}和 string 的区别（深层次问题-&gt;数组与切片的区别）</h4><p>string是不可变的字节序列，[]byte{}是可变的字节序列，简单地说string是字节数组，[]byte{}是字节切片</p>
<p>string为UTF-8编码 这导致len不一定是字符串中的个数 而是字节数</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>数组</tag>
        <tag>切片</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言基础6--context相关</title>
    <url>/2022/08/22/go9/</url>
    <content><![CDATA[<h3 id="context-的使用，context是否并发安全（联动问题-gt-多个协程的同时控制）？"><a href="#context-的使用，context是否并发安全（联动问题-gt-多个协程的同时控制）？" class="headerlink" title="context 的使用，context是否并发安全（联动问题-&gt;多个协程的同时控制）？"></a>context 的使用，context是否并发安全（联动问题-&gt;多个协程的同时控制）？</h3><blockquote>
<p>Go 的 Context 的数据结构包含 Deadline，Done，Err，Value；它可以控制一组呈树状结构的goroutine，每个goroutine拥有相同的上下文。通过context包，可以非常方便地在请求goroutine之间传递请求数据、取消信号和超时信息。</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
   <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>
   <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
   <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
   <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>基础的context接口只定义了4个方法，下面分别简要说明一下：</p>
<ul>
<li><strong>Deadline</strong> 方法：可以获取设置的截止时间，返回值 deadline 是截止时间，到了这个时间，Context 会自动发起取消请求，返回值 ok 表示是否设置了截止时间。</li>
<li><strong>Done</strong> 方法：返回一个只读的 channel ，类型为 struct{}。如果这个 chan 可以读取，说明已经发出了取消信号，可以做清理操作，然后退出协程，释放资源。</li>
<li><strong>Err</strong> 方法：返回Context 被取消的原因。</li>
<li><strong>Value</strong> 方法：获取 Context 上绑定的值，是一个键值对，通过 key 来获取对应的值。</li>
</ul>
<blockquote>
<p> 最常用的是 Done 方法，在 Context 取消的时候，会关闭这个只读的 Channel，相当于发出了取消信号。</p>
</blockquote>
<span id="more"></span>

<p><strong>其主要的应用 ：</strong></p>
<p><strong>1：上下文控制，2：多个 goroutine 之间的数据交互等，3：超时控制：到某个时间点超时，过多久超时。</strong></p>
<h4 id="Context的使用"><a href="#Context的使用" class="headerlink" title="Context的使用"></a>Context的使用</h4><blockquote>
<p>我们可以使用 select+channel 来实现了部分协程的终止，但是如果我们想要同时取消多个协程怎么办呢？如果需要定时取消又怎么办呢？</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	ctx<span class="token punctuation">,</span> stop <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//工作3秒</span>
	<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//3秒后发出停止指令 context的停止函数</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"结束"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"运行中..."</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
</blockquote>
<h4 id="context是并发安全的，为什么呢？"><a href="#context是并发安全的，为什么呢？" class="headerlink" title="context是并发安全的，为什么呢？"></a>context是并发安全的，为什么呢？</h4><p>context包提供两种创建根context的方式：</p>
<ul>
<li>context.Backgroud()</li>
<li>context.TODO()</li>
</ul>
<p>又提供了四个函数基于父Context衍生，其中使用WithValue函数来衍生context并携带数据，每次调用WithValue函数都会基于当前context衍生一个新的子context，WithValue内部主要就是调用valueCtx类：</p>
<p>valueCtx结构如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> valueCtx <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
 Context
 key<span class="token punctuation">,</span> val <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token number">1.2</span><span class="token number">.3</span><span class="token number">.4</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>valueCtx继承父Context，这种是采用匿名接口的继承实现方式，key，val用来存储携带的键值对。</p>
<p>通过上面的代码分析，可以看到添加键值对不是在原context结构体上直接添加，而是以此context作为父节点，重新创建一个新的valueCtx子节点，将键值对添加在子节点上，由此形成一条context链。</p>
<p>获取键值过程也是层层向上调用直到最终的根节点，中间要是找到了key就会返回，否会就会找到最终的emptyCtx返回nil。画个图表示一下：</p>
<p><img src="/2022/08/22/go9/9296c3327c96ad3d25f565bab2b8a5dee8c7ed.webp" alt="img"></p>
<p><strong>总结：</strong>context添加的键值对是链式的，会不断衍生新的context，所以context本身是不可变的，因此是线程安全的。</p>
<blockquote>
<p><strong>参考文章：</strong><a href="https://juejin.cn/post/6986455142480478222">Go语言，并发控制神器之Context - 掘金 (juejin.cn)</a></p>
<p><strong>参考文章：</strong> <a href="https://www.51cto.com/article/700728.html">面试官：Context携带数据是线程安全的吗？-51CTO.COM</a></p>
</blockquote>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>context</tag>
      </tags>
  </entry>
  <entry>
    <title>go语言的并发机制</title>
    <url>/2022/08/19/goRoutine/</url>
    <content><![CDATA[<h2 id="go语言并发原理"><a href="#go语言并发原理" class="headerlink" title="go语言并发原理"></a>go语言并发原理</h2><blockquote>
<p>Go不推荐用共享内存的方式传递数据，而推荐使用channel(或称“通道” )。channel主要用来在多个goroutine之间传递数据，并且还</p>
<p>会保证整个过程的并发安全性。不过，作为可选方法，Go依然提供了一些传统的同步方法 (比如互斥量、 条件变量等)。</p>
<p><strong>Go的并发机制</strong>指的是用于支撑goroutine 和channel的底层原理，说到这个就不得不提go语言的调度模型，GMP。</p>
</blockquote>
<h3 id="GMP调度模型"><a href="#GMP调度模型" class="headerlink" title="GMP调度模型"></a>GMP调度模型</h3><p>说起Go的线程实现模型,有3个必知的核心元素,它们支撑起了这个模型的主框架，<br>简要说明如下：</p>
<ul>
<li>M: machine的缩写。一个M代表一个内核线程，或称“工作线程”。</li>
<li>P: processor的缩写。一个P代表执行一个Go代码片段所必需的资源(或称“上下文环境”)。</li>
<li>G: goroutine的缩写。一个G代表一 个Go代码片段。前者是对后者的一种封装。</li>
</ul>
<p>.未完待续~~~</p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>windows上使用go-wrk进行接口压力测试</title>
    <url>/2022/09/16/go_wrk/</url>
    <content><![CDATA[<h2 id="Go开发接口测试过程记录"><a href="#Go开发接口测试过程记录" class="headerlink" title="Go开发接口测试过程记录"></a>Go开发接口测试过程记录</h2><h3 id="压测工具准备"><a href="#压测工具准备" class="headerlink" title="压测工具准备"></a>压测工具准备</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> install github<span class="token punctuation">.</span>com<span class="token operator">/</span>adjust<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>wrk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="测试接口准备"><a href="#测试接口准备" class="headerlink" title="测试接口准备"></a>测试接口准备</h3><blockquote>
<p>将开发中的接口写一个简单的测试接口用例，方便wrk模拟调用</p>
<p>把参数提取加入</p>
</blockquote>
<span id="more"></span>

<p>第一次测试接口，直接将参数写死，<strong>未能模拟最真实的场景-待研究</strong></p>
<p><img src="/2022/09/16/go_wrk/image-20220916170228589.png" alt="image-20220916170228589"></p>
<h3 id="开始压力测试"><a href="#开始压力测试" class="headerlink" title="开始压力测试"></a>开始压力测试</h3><p>工具下载后，<code>go-wrk.exe</code>出现在<code>GOPATH/bin/</code>下</p>
<p>在该路径下直接cmd，或者使用命令行到该路径下</p>
<p><strong>开启Web服务</strong></p>
<p>使用以下命令进行测试</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"># <span class="token number">8</span>个线程，<span class="token number">400</span>个连接， 模拟1w次请求  <span class="token operator">-</span>d替换<span class="token operator">-</span>n表示连接时间
<span class="token keyword">go</span><span class="token operator">-</span>wrk <span class="token operator">-</span>c<span class="token operator">=</span><span class="token number">400</span> <span class="token operator">-</span>t<span class="token operator">=</span><span class="token number">8</span> <span class="token operator">-</span>n<span class="token operator">=</span><span class="token number">10000</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8082</span><span class="token operator">/</span>product<span class="token operator">/</span>qrder<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">D:\goProject\bin>go-wrk <span class="token operator">-</span>h
Usage of go-wrk:
  <span class="token operator">-</span>CA string
        A PEM eoncoded CA<span class="token string">'s certificate file. (default "someCertCAFile")
  -H string
        the http headers sent separated by '</span>\n' <span class="token punctuation">(</span>default <span class="token string">"User-Agent: go-wrk 0.1 benchmark\nContent-Type: text/html;"</span><span class="token punctuation">)</span>
  <span class="token operator">-</span>b string
        the http request body
  <span class="token operator">-</span>c int
        the max numbers of connections used <span class="token punctuation">(</span>default 100<span class="token punctuation">)</span>
  <span class="token operator">-</span>cert string
        A PEM eoncoded certificate file<span class="token punctuation">.</span> <span class="token punctuation">(</span>default <span class="token string">"someCertFile"</span><span class="token punctuation">)</span>
  <span class="token operator">-</span>d string
        dist mode
  <span class="token operator">-</span>f string
        json config file
  <span class="token operator">-</span>i    TLS checks are disabled
  <span class="token operator">-</span>k    <span class="token keyword">if</span> keep-alives are disabled <span class="token punctuation">(</span>default true<span class="token punctuation">)</span>
  <span class="token operator">-</span>key string
        A PEM encoded private key file<span class="token punctuation">.</span> <span class="token punctuation">(</span>default <span class="token string">"someKeyFile"</span><span class="token punctuation">)</span>
  <span class="token operator">-</span>m string
        the http request method <span class="token punctuation">(</span>default <span class="token string">"GET"</span><span class="token punctuation">)</span>
  <span class="token operator">-</span>n int
        the total number of calls processed <span class="token punctuation">(</span>default 1000<span class="token punctuation">)</span>
  <span class="token operator">-</span>p string
        the http request body <span class="token keyword">data</span> file
  <span class="token operator">-</span>r    in the case of having stream or file in the response<span class="token punctuation">,</span>
         it reads all response body to calculate the response size
  <span class="token operator">-</span>s string
        <span class="token keyword">if</span> specified<span class="token punctuation">,</span> it counts how often the searched string s is contained in the responses
  <span class="token operator">-</span>t int
        the numbers of threads used <span class="token punctuation">(</span>default 1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试效果如下</p>
<p><img src="/2022/09/16/go_wrk/image-20220921170806211.png" alt="image-20220921170806211"></p>
<p>每秒 929.15次连接 也可以说 QPS为 929.15</p>
<p>因继续改进，出现连接错误与超卖现象</p>
<p>使用本地Windows10 16G内存 CPU i7-9750H 8核 进行测试</p>
]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>golang学习路线，所需知识</title>
    <url>/2022/08/17/golangStudy/</url>
    <content><![CDATA[<h2 id="计算机基础"><a href="#计算机基础" class="headerlink" title="计算机基础"></a>计算机基础</h2><h3 id="1-操作系统"><a href="#1-操作系统" class="headerlink" title="1. 操作系统"></a>1. 操作系统</h3><ul>
<li><h5 id="了解进程、线程、协程的区别"><a href="#了解进程、线程、协程的区别" class="headerlink" title="了解进程、线程、协程的区别"></a>了解进程、线程、协程的区别</h5></li>
<li><h5 id="了解进程间常用的通信方式"><a href="#了解进程间常用的通信方式" class="headerlink" title="了解进程间常用的通信方式"></a>了解进程间常用的通信方式</h5><ol>
<li>管道</li>
<li>命名管道（FIFO）</li>
<li>消息队列</li>
<li>信号量</li>
<li>共享内存</li>
<li>套接字（Socket）</li>
</ol>
</li>
<li><h5 id="了解5种网络IO模型"><a href="#了解5种网络IO模型" class="headerlink" title="了解5种网络IO模型"></a>了解5种网络IO模型</h5><ol>
<li>阻塞 IO（blocking IO）</li>
<li>非阻塞 IO（non-blocking IO）</li>
<li>多路复用 IO（IO multiplexing）</li>
<li>异步 IO（Asynchronous I/O）</li>
<li>信号驱动 IO（signal driven I/O， SIGIO）</li>
</ol>
<span id="more"></span></li>
<li><h5 id="了解并发与并行的区别"><a href="#了解并发与并行的区别" class="headerlink" title="了解并发与并行的区别"></a>了解并发与并行的区别</h5><ol>
<li>并发是指一个处理器同时处理多个任务。</li>
<li>并行是指多个处理器或者是多核的处理器同时处理多个不同的任务。</li>
<li>并发是逻辑上的同时发生（simultaneous），而并行是物理上的同时发生。</li>
<li>并行在多处理器系统中存在，而并发可以在单处理器和多处理器系统中都存在，</li>
<li>并发能够在单处理器系统中存在是因为并发是并行的假象，并行要求程序能够同时执行多个操作，而并发只是要求程序假装同时执行多个操作（每个小时间片执行一个操作，多个操作快速切换执行）。</li>
</ol>
</li>
<li><h5 id="了解同步与异步的区别"><a href="#了解同步与异步的区别" class="headerlink" title="了解同步与异步的区别"></a>了解同步与异步的区别</h5><ol>
<li>同步：同步是指一个进程在执行某个请求的时候，如果该请求需要一段时间才能返回信息，那么这个进程会一直等待下去，直到收到返回信息才继续执行下去。</li>
<li>异步：异步是指进程不需要一直等待下去，而是继续执行下面的操作，不管其他进程的状态，当有信息返回的时候会通知进程进行处理，这样就可以提高执行的效率了，即异步是我们发出的一个请求，该请求会在后台自动发出并获取数据，然后对数据进行处理，在此过程中，我们可以继续做其他操作，不管它怎么发出请求，不关心它怎么处理数据。</li>
<li>以上总结起来，通俗地讲，也就是说，同步需要按部就班地走完一整个流程，完成一整个动作，打个比方：同步的时候，你在写程序，然后你妈妈叫你马上拖地，你就必须停止写程序然后拖地，没法同时进行。而异步则不需要按部就班，可以在等待那个动作的时候同时做别的动作，</li>
</ol>
</li>
<li><h5 id="了解阻塞与非阻塞的区别"><a href="#了解阻塞与非阻塞的区别" class="headerlink" title="了解阻塞与非阻塞的区别"></a>了解阻塞与非阻塞的区别</h5></li>
<li><h5 id="了解常见缓存淘汰算法："><a href="#了解常见缓存淘汰算法：" class="headerlink" title="了解常见缓存淘汰算法："></a>了解常见缓存淘汰算法：</h5><ol>
<li>LRU（Least Recently Used）最近最少使用算法 </li>
<li>LFU（Least Frequently Used）最近频次最少算法 </li>
<li>FIFO（First In First Out）先入先出算法 </li>
<li>ARC（Adjustable Replacement Cache）自适应缓存替换算法</li>
</ol>
</li>
</ul>
<h3 id="2-计算机网络"><a href="#2-计算机网络" class="headerlink" title="2. 计算机网络"></a>2. 计算机网络</h3><ul>
<li><h5 id="了解网络协议"><a href="#了解网络协议" class="headerlink" title="了解网络协议"></a>了解网络协议</h5></li>
<li><h5 id="了解序列化协议"><a href="#了解序列化协议" class="headerlink" title="了解序列化协议"></a>了解序列化协议</h5></li>
<li><h5 id="了解七层体系结构"><a href="#了解七层体系结构" class="headerlink" title="了解七层体系结构"></a>了解七层体系结构</h5></li>
<li><h5 id="了解四层体系结构"><a href="#了解四层体系结构" class="headerlink" title="了解四层体系结构"></a>了解四层体系结构</h5></li>
</ul>
<h3 id="3-计算机组成原理（冯诺依曼体系）-了解"><a href="#3-计算机组成原理（冯诺依曼体系）-了解" class="headerlink" title="3. 计算机组成原理（冯诺依曼体系）[了解]"></a>3. 计算机组成原理（冯诺依曼体系）[了解]</h3><h3 id="4-数据结构与算法"><a href="#4-数据结构与算法" class="headerlink" title="4. 数据结构与算法"></a>4. 数据结构与算法</h3><ul>
<li><h5 id="了解时间-空间复杂度"><a href="#了解时间-空间复杂度" class="headerlink" title="了解时间/空间复杂度"></a>了解时间/空间复杂度</h5></li>
<li><h5 id="熟悉常用数据结构"><a href="#熟悉常用数据结构" class="headerlink" title="熟悉常用数据结构"></a>熟悉常用数据结构</h5><p>字符串<br>数组<br>链表<br>队列<br>二叉树<br>栈<br>堆</p>
</li>
<li><h5 id="熟悉常用算法"><a href="#熟悉常用算法" class="headerlink" title="熟悉常用算法"></a>熟悉常用算法</h5><p>双指针<br>左右指针<br>排序<br>二叉查找<br>递归<br>回溯<br>贪心<br>动态规划</p>
</li>
</ul>
<h3 id="5-互联网（Internet）"><a href="#5-互联网（Internet）" class="headerlink" title="5. 互联网（Internet）"></a>5. 互联网（Internet）</h3><ul>
<li><h5 id="互联网是如何工作的"><a href="#互联网是如何工作的" class="headerlink" title="互联网是如何工作的"></a>互联网是如何工作的</h5></li>
<li><h5 id="HTTP是什么"><a href="#HTTP是什么" class="headerlink" title="HTTP是什么"></a>HTTP是什么</h5></li>
<li><h5 id="浏览器以及浏览器如何运作"><a href="#浏览器以及浏览器如何运作" class="headerlink" title="浏览器以及浏览器如何运作"></a>浏览器以及浏览器如何运作</h5></li>
<li><h5 id="域名是什么"><a href="#域名是什么" class="headerlink" title="域名是什么"></a>域名是什么</h5></li>
<li><h5 id="hosting是什么"><a href="#hosting是什么" class="headerlink" title="hosting是什么"></a>hosting是什么</h5></li>
</ul>
<h3 id="6-数据库"><a href="#6-数据库" class="headerlink" title="6. 数据库"></a>6. 数据库</h3><ul>
<li><h5 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h5><p>Mysql</p>
</li>
<li><h5 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h5><p>Redis</p>
</li>
</ul>
<h2 id="Golang编程基础"><a href="#Golang编程基础" class="headerlink" title="Golang编程基础"></a>Golang编程基础</h2><ul>
<li>字符串</li>
<li>常量</li>
<li>变量</li>
<li>类型</li>
<li>操作符</li>
<li>表达式</li>
<li>语句</li>
<li>错误处理</li>
</ul>
<h3 id="1-代码组织"><a href="#1-代码组织" class="headerlink" title="1. 代码组织"></a>1. 代码组织</h3><h3 id="2-标准库"><a href="#2-标准库" class="headerlink" title="2. 标准库"></a>2. 标准库</h3><ul>
<li><h5 id="功能性"><a href="#功能性" class="headerlink" title="功能性"></a>功能性</h5><p>net<br>errors<br>os<br>sync<br>time</p>
</li>
<li><h5 id="输入输出型"><a href="#输入输出型" class="headerlink" title="输入输出型"></a>输入输出型</h5><p>io<br>fmt<br>log</p>
</li>
</ul>
<h3 id="3-版本控制"><a href="#3-版本控制" class="headerlink" title="3. 版本控制"></a>3. 版本控制</h3><ul>
<li><h5 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h5></li>
</ul>
<h2 id="Go编程进阶"><a href="#Go编程进阶" class="headerlink" title="Go编程进阶"></a>Go编程进阶</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul>
<li><strong>map</strong></li>
<li><strong>channel</strong></li>
<li><strong>goroutine</strong></li>
<li><strong>slice</strong></li>
<li><strong>runtime</strong></li>
</ul>
<h3 id="GMP"><a href="#GMP" class="headerlink" title="GMP"></a>GMP</h3><h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><h3 id="CGO"><a href="#CGO" class="headerlink" title="CGO"></a>CGO</h3><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul>
<li><strong>单元测试</strong></li>
<li><strong>压力测试</strong></li>
<li><strong>覆盖测试</strong></li>
<li><strong>性能测试</strong></li>
</ul>
<h3 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h3><ul>
<li><p><strong>goroutine调度</strong></p>
</li>
<li><p><strong>channel调度</strong></p>
</li>
<li><p><strong>锁</strong></p>
</li>
<li><p><strong>waitGroup</strong></p>
</li>
<li><p><strong>context</strong></p>
</li>
<li><p><strong>sync</strong></p>
</li>
<li><p><strong>atomic</strong></p>
</li>
</ul>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><p><img src="/2022/08/17/golangStudy/image-20220805143702043.png" alt="image-20220805143702043"></p>
<h2 id="数据结构与算法（熟练掌握）"><a href="#数据结构与算法（熟练掌握）" class="headerlink" title="数据结构与算法（熟练掌握）"></a>数据结构与算法（熟练掌握）</h2><h2 id="计算机原理与网络"><a href="#计算机原理与网络" class="headerlink" title="计算机原理与网络"></a>计算机原理与网络</h2><p><img src="/2022/08/17/golangStudy/image-20220805143827008.png" alt="image-20220805143827008"></p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p><img src="/2022/08/17/golangStudy/image-20220805143839926.png" alt="image-20220805143839926"></p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p><img src="/2022/08/17/golangStudy/image-20220805143854645.png" alt="image-20220805143854645"></p>
<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><p><img src="/2022/08/17/golangStudy/image-20220805143913401.png" alt="image-20220805143913401"></p>
<p><img src="/2022/08/17/golangStudy/image-20220805143922828.png" alt="image-20220805143922828"></p>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p><img src="/2022/08/17/golangStudy/image-20220805143950466.png" alt="image-20220805143950466"></p>
<h2 id="工程化"><a href="#工程化" class="headerlink" title="工程化"></a>工程化</h2><h3 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h3><p><img src="/2022/08/17/golangStudy/image-20220805144025693.png" alt="image-20220805144025693"></p>
<h3 id="Web框架"><a href="#Web框架" class="headerlink" title="Web框架"></a>Web框架</h3><p><img src="/2022/08/17/golangStudy/image-20220805144030069.png" alt="image-20220805144030069"></p>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p><img src="/2022/08/17/golangStudy/image-20220805144116432.png" alt="image-20220805144116432"></p>
]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>golang学习路线</tag>
      </tags>
  </entry>
  <entry>
    <title>linux系统</title>
    <url>/2022/08/24/linux1/</url>
    <content><![CDATA[<p>Linux 最常用命令！</p>
<p>Linux是目前应用最广泛的服务器操作系统，基于Unix，开源免费，由于系统的稳定性和安全性，市场占有率很高，几乎成为程序代码运行的最佳系统环境。</p>
<p>linux不仅可以长时间的运行我们编写的程序代码，还可以安装在各种计算机硬件设备中，如手机、路由器等，Android程序最底层就是运行在linux系统上的。</p>
<h2 id="linux的目录结构"><a href="#linux的目录结构" class="headerlink" title="linux的目录结构"></a>linux的目录结构</h2><p><img src="/2022/08/24/linux1/linux1.png"></p>
<span id="more"></span>

<ul>
<li>bin  (binaries)存放二进制可执行文件</li>
<li>sbin  (super user binaries)存放二进制可执行文件，只有root才能访问</li>
<li>etc (etcetera)存放系统配置文件</li>
<li>usr  (unix shared resources)用于存放共享的系统资源</li>
<li>home 存放用户文件的根目录</li>
<li>root  超级用户目录</li>
<li>dev (devices)用于存放设备文件</li>
<li>lib  (library)存放跟文件系统中的程序运行所需要的共享库及内核模块</li>
<li>mnt  (mount)系统管理员安装临时文件系统的安装点</li>
<li>boot 存放用于系统引导时使用的各种文件</li>
<li>tmp  (temporary)用于存放各种临时文件</li>
<li>var  (variable)用于存放运行时需要改变数据的文件</li>
</ul>
<h2 id="linux常用命令"><a href="#linux常用命令" class="headerlink" title="linux常用命令"></a>linux常用命令</h2><p>命令格式：命令  -选项  参数 （选项和参数可以为空）</p>
<p>如：ls  -la  /usr</p>
<ul>
<li><h3 id="操作文件及目录"><a href="#操作文件及目录" class="headerlink" title="操作文件及目录"></a>操作文件及目录</h3></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>cd</td>
<td></td>
<td>cd /home</td>
<td>切换目录</td>
</tr>
<tr>
<td>pwd</td>
<td></td>
<td>pwd</td>
<td>显示当前工作目录目录</td>
</tr>
<tr>
<td>touch</td>
<td></td>
<td>touch 1.txt</td>
<td>创建空文件</td>
</tr>
<tr>
<td>mkdir</td>
<td></td>
<td>mkdir testdir</td>
<td>创建一个新目录</td>
</tr>
<tr>
<td></td>
<td>-p</td>
<td>mkidr -p dir1/dir2/dir3/</td>
<td>创建多级目录，父目录不存在情况下先生成父目录</td>
</tr>
<tr>
<td>cp</td>
<td></td>
<td>cp 1.txt</td>
<td>复制文件或目录</td>
</tr>
<tr>
<td></td>
<td>-r</td>
<td>cp -r dir1/</td>
<td>递归处理，将指定目录下的文件与子目录一并拷贝</td>
</tr>
<tr>
<td>mv</td>
<td></td>
<td>mv dir1 dir2</td>
<td>移动文件或目录、文件或目录改名</td>
</tr>
<tr>
<td>rm</td>
<td></td>
<td>rm 1.txt</td>
<td>删除文件</td>
</tr>
<tr>
<td></td>
<td>-r</td>
<td>rm -rf dir1</td>
<td>r同时删除该目录下的所有文件</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td>rm -rf dir1</td>
<td>f强制删除文件或目录</td>
</tr>
<tr>
<td>rmdir</td>
<td></td>
<td>rmdir dir1</td>
<td>删除空目录</td>
</tr>
<tr>
<td>cat</td>
<td></td>
<td>cat 1.txt</td>
<td>显示文本文件内容</td>
</tr>
<tr>
<td>more</td>
<td></td>
<td>more 1.txt</td>
<td>分页显示文本文件内容，可前后翻页，空格向后，b向前</td>
</tr>
<tr>
<td>less</td>
<td></td>
<td>less 1.txt</td>
<td>分页显示文本文件内容，可前后翻页，空格向后，b向前，支持底行模式（后面介绍）</td>
</tr>
<tr>
<td>head</td>
<td></td>
<td>head 1.txt</td>
<td>查看文本开头部分，默认十行</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td>head -20 1.txt</td>
<td>查看文本开头部分指定行数</td>
</tr>
<tr>
<td>tail</td>
<td></td>
<td>tail 1.txt</td>
<td>查看文本结尾部分，默认十行</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td>tail -20 1.txt</td>
<td>查看文本结尾部分指定行数</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td>tail -f 1.txt</td>
<td>循环滚动读取文件并动态显示在屏幕上，根据文件属性追踪</td>
</tr>
<tr>
<td></td>
<td>-F</td>
<td>tail -F 1.txt</td>
<td>循环滚动读取文件并动态显示在屏幕上，文件文件名追踪</td>
</tr>
<tr>
<td>wc</td>
<td></td>
<td>wc 1.txt</td>
<td>统计文本的行数、字数、字符数</td>
</tr>
<tr>
<td></td>
<td>-m</td>
<td>wc -m 1.txt</td>
<td>字符数</td>
</tr>
<tr>
<td></td>
<td>-w</td>
<td>wc -w 1.txt</td>
<td>文本字数</td>
</tr>
<tr>
<td></td>
<td>-l</td>
<td>wc -l 1.txt</td>
<td>文本行数</td>
</tr>
<tr>
<td>find</td>
<td>-name</td>
<td>find / -name 1.txt</td>
<td>在文件系统中的指定目录下查找指定的文件</td>
</tr>
<tr>
<td>grep</td>
<td></td>
<td>grep aaa 1.txt</td>
<td>在指定文件中查找包含指定内容的行，例：在1.txt中查找包含aaa的所有行</td>
</tr>
<tr>
<td>ln</td>
<td></td>
<td>ln 1.txt 1_bak.txt</td>
<td>建立链接文件</td>
</tr>
<tr>
<td></td>
<td>-s</td>
<td>ln -s 1.txt 1_bak.txt</td>
<td>对源文件建立符号连接，而非硬连接</td>
</tr>
</tbody></table>
<ul>
<li><h3 id="系统常用命令"><a href="#系统常用命令" class="headerlink" title="系统常用命令"></a>系统常用命令</h3></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>top</td>
<td></td>
<td>top</td>
<td>显示当前系统中耗费资源最多的进程</td>
</tr>
<tr>
<td>date</td>
<td></td>
<td>date</td>
<td>显示系统当前时间</td>
</tr>
<tr>
<td>ps</td>
<td></td>
<td></td>
<td>较少单独使用，配参数根据需求，ps -ef 或者ps-aux</td>
</tr>
<tr>
<td></td>
<td>-e /-A</td>
<td>ps -e</td>
<td>显示所有进程，环境变量</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td>ps -ef</td>
<td>全格式显示</td>
</tr>
<tr>
<td></td>
<td>-a</td>
<td>ps -a</td>
<td>显示所有用户的所有进程（包括其它用户）</td>
</tr>
<tr>
<td></td>
<td>-u</td>
<td>ps -au</td>
<td>按用户名和启动时间的顺序来显示进程</td>
</tr>
<tr>
<td></td>
<td>-x</td>
<td>ps -aux</td>
<td>显示无控制终端的进程</td>
</tr>
<tr>
<td>kill</td>
<td>-9</td>
<td>kill -9 pid</td>
<td>强制杀死一个进程</td>
</tr>
<tr>
<td>df</td>
<td></td>
<td>df</td>
<td>显示文件系统磁盘空间的使用情况</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>df -h</td>
<td>以人类可读的方式显示，Kb，Mb，GB等</td>
</tr>
<tr>
<td>du</td>
<td></td>
<td></td>
<td>显示指定的目录及其子目录已使用的磁盘空间的总和</td>
</tr>
<tr>
<td></td>
<td>-s</td>
<td>du -s *</td>
<td>进显示指定目录的总和，星号当前目录下表示所有</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>du -sh *</td>
<td>以人类可读的方式显示，Kb，Mb，GB等</td>
</tr>
<tr>
<td>free</td>
<td></td>
<td>free</td>
<td>显示当前内存和交换空间的使用情况</td>
</tr>
<tr>
<td>ifconfig</td>
<td></td>
<td>ifconfig</td>
<td>网卡网络配置，常用于查看当前IP地址</td>
</tr>
<tr>
<td></td>
<td></td>
<td>ifconfig eth0 192.168.12.22</td>
<td>临时修改系统IP（重启后失效）</td>
</tr>
<tr>
<td>ping</td>
<td></td>
<td>ping baidu.com</td>
<td>测试网络的连通性</td>
</tr>
<tr>
<td>hostname</td>
<td></td>
<td>hostname</td>
<td>查看主机名</td>
</tr>
<tr>
<td>shutdown</td>
<td>-r</td>
<td>shutdown -r</td>
<td>先关机，再重启</td>
</tr>
<tr>
<td></td>
<td>-h</td>
<td>shutdown -h</td>
<td>关机后不重启</td>
</tr>
<tr>
<td>halt</td>
<td></td>
<td>halt</td>
<td>关机后关闭电源，相当于shutdown -h</td>
</tr>
<tr>
<td>reboot</td>
<td></td>
<td>reboot</td>
<td>重新启动 相当于shutdown -r</td>
</tr>
</tbody></table>
<ul>
<li><h3 id="压缩解压缩"><a href="#压缩解压缩" class="headerlink" title="压缩解压缩"></a>压缩解压缩</h3></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>gzip</td>
<td></td>
<td>gzip 1.txt</td>
<td>压缩后面的文件或者文件夹</td>
</tr>
<tr>
<td></td>
<td>-d</td>
<td>gzip -d 1.txt.gz</td>
<td>解压后面的压缩文件</td>
</tr>
<tr>
<td></td>
<td>-[num]</td>
<td>gzip -9 1.txt</td>
<td>用指定的数字num调整压缩的速度，-1或–fast表示最快压缩方法（低压缩比），-9或–best表示最慢压缩方法（高压缩比）。系统缺省值为6</td>
</tr>
<tr>
<td>tar</td>
<td>-c</td>
<td>tar -cvf 1.tar 1.txt</td>
<td>建立一个压缩文件的参数指令，例，将1.txt压缩为1.tar，也可指定多个文件或文件夹</td>
</tr>
<tr>
<td></td>
<td>-x</td>
<td>tar -xvf 1.tar 1.txt</td>
<td>解开一个压缩文件的参数指令</td>
</tr>
<tr>
<td></td>
<td>-z</td>
<td>tar -zcvf 1.tar.gz 1.txt / tar -zxvf 1.tar.gz 1.txt</td>
<td>是否需要用 gzip ，使用gzip压缩或解压</td>
</tr>
<tr>
<td></td>
<td>-v</td>
<td></td>
<td>压缩的过程中显示文件</td>
</tr>
<tr>
<td></td>
<td>-f</td>
<td></td>
<td>使用档名，在 f 之后要立即接档名</td>
</tr>
</tbody></table>
<ul>
<li><h3 id="文件权限操作"><a href="#文件权限操作" class="headerlink" title="文件权限操作"></a>文件权限操作</h3><p>linux文件权限的描述格式解读</p>
</li>
</ul>
<p><img src="/2022/08/24/linux1/linux2.png"></p>
<p>r 可读权限，w可写权限，x可执行权限（也可以用二进制表示  111 110 100  –&gt;  764）</p>
<ul>
<li>第1位：文件类型（d 目录，- 普通文件，l 链接文件）</li>
<li>第2-4位：所属用户权限，用u（user）表示</li>
<li>第5-7位：所属组权限，用g（group）表示</li>
<li>第8-10位：其他用户权限，用o（other）表示</li>
<li>第2-10位：表示所有的权限，用a（all）表示</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>chmod</td>
<td></td>
<td>chmod u+r 1.txt</td>
<td>修改文件或目录的权限，u表示当前用户，g表示同组用户，o表示其他用户，a表示所有用户，r表示可读，w表示可写，x表示可执行；例：修改1.txt文件给当前用户添加可执行权限</td>
</tr>
<tr>
<td></td>
<td>-R</td>
<td>chmod -R u+r dir1</td>
<td>修改指定目录及其子目录的所有文件的权限</td>
</tr>
<tr>
<td></td>
<td>三位数字</td>
<td>chmod 764 1.sh</td>
<td>直接指定文件的权限，7：表示可读可写可执行，4+2+1；6：表示可读可写，4+2；…</td>
</tr>
<tr>
<td>chown</td>
<td></td>
<td>chown user1:group1 1.txt</td>
<td>修改文件的所属用户和组；例：将1.txt文件的所属用户指定为user1，组为group1</td>
</tr>
<tr>
<td></td>
<td>-R</td>
<td>chown -R user1:group1 1.txt</td>
<td>修改目录下所有文件及子目录的所属用户和组，用数字来表示权限（r=4，w=2，x=1，-=0）</td>
</tr>
</tbody></table>
<ul>
<li><h3 id="linux系统常用快捷键及符号命令"><a href="#linux系统常用快捷键及符号命令" class="headerlink" title="linux系统常用快捷键及符号命令"></a>linux系统常用快捷键及符号命令</h3></li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ctrl + c</td>
<td></td>
<td></td>
<td>停止进程</td>
</tr>
<tr>
<td>ctrl + l</td>
<td></td>
<td></td>
<td>清屏</td>
</tr>
<tr>
<td>ctrl + r</td>
<td></td>
<td></td>
<td>搜索历史命令</td>
</tr>
<tr>
<td>ctrl + q</td>
<td></td>
<td></td>
<td>退出</td>
</tr>
<tr>
<td>tab</td>
<td></td>
<td></td>
<td>自动补全</td>
</tr>
<tr>
<td>&gt;</td>
<td></td>
<td>echo “haha” &gt; 1.txt</td>
<td>将前一条命令的输出，写入到后面的文本中，将文本清空，然后写入</td>
</tr>
<tr>
<td>&gt;&gt;</td>
<td></td>
<td>echo “lala” &gt;&gt; 1.txt</td>
<td>将前一条命令的输出，写入到后面的文本中，不清空文本，追加到文本最后</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td>cat 1.txt</td>
</tr>
<tr>
<td>*</td>
<td></td>
<td></td>
<td>通配符，指所有</td>
</tr>
</tbody></table>
<ul>
<li><h3 id="vim编辑器"><a href="#vim编辑器" class="headerlink" title="vim编辑器"></a>vim编辑器</h3></li>
</ul>
<p>vi / vim是Linux上最常用的文本编辑器而且功能非常强大。只有命令，没有菜单，下图表示vi命令的各种模式的切换图。</p>
<p><img src="/2022/08/24/linux1/linux3.png"></p>
<ul>
<li>修改文本</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>在光标前插入</td>
</tr>
<tr>
<td>I</td>
<td>在光标当前行开始插入</td>
</tr>
<tr>
<td>a</td>
<td>在光标后插入</td>
</tr>
<tr>
<td>A</td>
<td>在光标当前行末尾插入</td>
</tr>
<tr>
<td>o</td>
<td>在光标当前行的下一行插入新行</td>
</tr>
<tr>
<td>O</td>
<td>在光标当前行的上一行插入新行</td>
</tr>
<tr>
<td>:wq</td>
<td>保存并退出</td>
</tr>
<tr>
<td>q</td>
<td>退出程序</td>
</tr>
<tr>
<td>q!</td>
<td>强制退出</td>
</tr>
<tr>
<td>w</td>
<td>保存文件</td>
</tr>
<tr>
<td>wq filename</td>
<td>保存为指定文件名并退出</td>
</tr>
</tbody></table>
<ul>
<li>定位命令</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>:set nu</td>
<td>显示行号</td>
</tr>
<tr>
<td>:set nonu</td>
<td>取消行号</td>
</tr>
<tr>
<td>gg</td>
<td>跳到首行</td>
</tr>
<tr>
<td>G</td>
<td>跳到末行</td>
</tr>
<tr>
<td>:n</td>
<td>跳到第n行</td>
</tr>
</tbody></table>
<ul>
<li>替换和取消命令</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>u</td>
<td>undo，取消上一步操作</td>
</tr>
<tr>
<td>Ctrl + r</td>
<td>redo，返回到undo之前</td>
</tr>
<tr>
<td>r</td>
<td>替换光标所在处的字符</td>
</tr>
<tr>
<td>R</td>
<td>从光标所在处开始替换，按Esc键结束</td>
</tr>
</tbody></table>
<ul>
<li>删除命令</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>x</td>
<td>删除光标所在处字符</td>
</tr>
<tr>
<td>nx</td>
<td>删除光标所在处后的n个字符</td>
</tr>
<tr>
<td>dd</td>
<td>删除光标所在行。ndd删除n行</td>
</tr>
<tr>
<td>dG</td>
<td>删除光标所在行到末尾行的所以内容</td>
</tr>
<tr>
<td>D</td>
<td>删除光标所在处到行尾的内容</td>
</tr>
<tr>
<td>:5,7d</td>
<td>删除指定范围的行</td>
</tr>
</tbody></table>
<ul>
<li>常用快捷键</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Shift+ zz</td>
<td>保存退出，与“:wq”作用相同</td>
</tr>
<tr>
<td>v</td>
<td>进入字符可视模式</td>
</tr>
<tr>
<td>V</td>
<td>进入行可视模式</td>
</tr>
<tr>
<td>Ctrl + v</td>
<td>进入块可视模式</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>常用操作</tag>
      </tags>
  </entry>
  <entry>
    <title>linux系统后端常用命令</title>
    <url>/2022/08/24/linux2/</url>
    <content><![CDATA[<h1 id="1-常用指令"><a href="#1-常用指令" class="headerlink" title="1. 常用指令"></a>1. 常用指令</h1><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://blog.csdn.net/qq_24950043/article/details/126294756">连夜整理了多年后端开发最常用linux指令__linux软件运行指令</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1799381">面试常问的 25+ 个 Linux 命令 - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>
<p><a href="https://blog.csdn.net/u013197629/article/details/73608613">Linux权限详解（chmod、600、644、700、711、755、777、4755、6755、7755）_林20的博客-CSDN博客_权限700</a></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>常用操作</tag>
      </tags>
  </entry>
  <entry>
    <title>云服务器使用man命令出错</title>
    <url>/2022/09/03/linux3/</url>
    <content><![CDATA[<blockquote>
<p>报错信息：an: preconv: Bad system call (core dumped) man: nroff: Bad system call (core dumped)</p>
</blockquote>
<p>找到的原因是man 的版本与linux 的SECCOMP 机制有冲突。找到方法，禁用MAN 的SECCOMP。<br>临时使用：<br>MAN_DISABLE_SECCOMP=1 man ls<br>设到环境变理后：<br>export MAN_DISABLE_SECCOMP=1<br>就可以直接使用，不用每次都加MAN_DISABLE_SECCOMP=1这句。</p>
<p><strong>具体问题待解决~</strong></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>文档说明查询</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql进阶1——Mysql存储引擎与索引相关</title>
    <url>/2022/08/18/mysql1/</url>
    <content><![CDATA[<h3 id="MySql存储引擎"><a href="#MySql存储引擎" class="headerlink" title="MySql存储引擎"></a>MySql存储引擎</h3><h4 id="Mysql体系结构"><a href="#Mysql体系结构" class="headerlink" title="Mysql体系结构"></a>Mysql体系结构</h4><ul>
<li>连接层</li>
<li>服务层</li>
<li>引擎层</li>
<li>存储层</li>
</ul>
<h4 id="什么是存储引擎"><a href="#什么是存储引擎" class="headerlink" title="什么是存储引擎"></a>什么是存储引擎</h4><blockquote>
<p>存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于表的，而不是基于库的，所以存储引擎也可被称为表类型。</p>
</blockquote>
<span id="more"></span>

<h4 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h4><ul>
<li><p>InnoDB</p>
<pre><code>➢介绍：
      InnoDB是一种兼顾高可靠性和高性能的通用存储引擎,在MySQL 5.5之后, InnoDB是默认的MySQL存储引擎。
  ➢特点：
      DML操作遵循ACID模型，支持事务;
      行级锁，提高并发访问性能; 
      支持外键FOREIGN KEY约束,保证数据的完整性和正确性;
</code></pre>
<p>​    ➢文件：</p>
<p>​        xxx.ibd: xxx代表的是表名, innoDB引擎的每张表都会对应这样一个表空间文件, 存储该表的表结构(frm、 sdi) 、数据和索引。<br>​        参数: innpdb_ file_ per_ table    </p>
<p>​    ➢逻辑存储结构：</p>
<p>​        TableSpece:     表空间</p>
<p>​        |</p>
<p>​        segment:          段<br>​        |</p>
<p>​        Extent:I             区[1M—一个区可以有64个页]<br>​        |</p>
<p>​        Page:                 页[16K]<br>​        |</p>
<p>​        Row:                  行</p>
</li>
</ul>
<p><img src="/2022/08/18/mysql1/image-20220818151444624.png" alt="image-20220818151444624"></p>
<ul>
<li><p>MyISAM</p>
<pre><code>        ➢介绍
              MyISAM是MySQL早期的默认存储引擎。
          ➢特点
              不支持事务,不支持外键
              支持表锁，不支持行锁
              访问速度快
          ➢文件
              xxx.sdi:存储表结构信息
              XXX.MYD:存储数据
              XXX.MYI:存储索引
</code></pre>
</li>
<li><p>Memory</p>
<pre><code>        ➢介绍
              Memory引擎的表数据时存储在内存中的，由于受到硬件问题、或断电问题的影响，只能将这些表作为临时表或缓存使用。
          ➢特点
              内存存放
              hash索引( 默认)
          ➢文件
              xxx.sdi:存储表结构信息
</code></pre>
</li>
</ul>
<p><strong>MySql存储引擎特点总结：</strong></p>
<p><img src="/2022/08/18/mysql1/image-20220818151922258.png" alt="image-20220818151922258"></p>
<h4 id="存储引擎选择"><a href="#存储引擎选择" class="headerlink" title="存储引擎选择"></a>存储引擎选择</h4><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p>
<p>​            ➢InnoDB ：是Mysql的默认存储引擎， 支持事务、外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的-致</p>
<p>​                                性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，那么InnoDB存储 引擎是比较合适的选择。</p>
<p>​            ➢MyISAM：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那</p>
<p>​                                么选择这个存储引擎是非常合适的。<strong>（现如今被NOSQL-MongoDB替代）</strong></p>
<p>​            ➢MEMORY：将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表</p>
<p>​                                无法缓存在内存中，而且无法保障数据的安全性。<strong>（现如今被NOSQL-Redis替代）</strong></p>
<h3 id="Mysql索引（存储引擎层）"><a href="#Mysql索引（存储引擎层）" class="headerlink" title="Mysql索引（存储引擎层）"></a>Mysql索引（存储引擎层）</h3><h4 id="什么是索引"><a href="#什么是索引" class="headerlink" title="什么是索引"></a>什么是索引</h4><blockquote>
<p>索引(index)是帮助MySQL高效获取数据的数据结构(有序)。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用(指向)数据，这样就可以在这些数据结构上实现高级的查找算法，这种数据结构就是索引。</p>
<p><strong>简单的说，索引是一种数据结构，一种实现高级查找算法的数据结构。</strong></p>
</blockquote>
<h4 id="索引结构"><a href="#索引结构" class="headerlink" title="索引结构"></a>索引结构</h4><p>MySQL的索引是在存储引擎层实现的，不同的存储引擎有不同的结构,主要包含以下几种:</p>
<ul>
<li>B+Tree    ——    最常见的索引类型，大部分引擎都支持B+树索引</li>
<li>Hash       ——    底层数据结构是用哈希表实现的，只有精确匹配索引列的查询才有效，不支持范围查询</li>
<li>R-tree(空间索引)       ——  空间索引是MyISAM弓|擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</li>
<li>Full-text(全文索引)   ——  是一种通过建立倒排索引,快速匹配文档的方式。类似于Lucene，Solr，ES</li>
</ul>
<h4 id="索引结构与对应支持引擎"><a href="#索引结构与对应支持引擎" class="headerlink" title="索引结构与对应支持引擎"></a>索引结构与对应支持引擎</h4><p><img src="/2022/08/18/mysql1/image-20220818150013108.png" alt="image-20220818150013108"></p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>索引</tag>
        <tag>Mysql存储引擎</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么InnoDB存储引擎选择使用B+tree索引结构?</title>
    <url>/2022/08/18/mysql2/</url>
    <content><![CDATA[<p>由于B+tree所有数据都在叶子节点，上层节点仅仅起到索引结构，相对于二叉树，层级更少，搜索效率更高！</p>
<p><strong>如图：</strong></p>
<p><img src="/2022/08/18/mysql2/image-20220818153400906.png" alt="image-20220818153400906"></p>
<p>其他结构讲解，链接—-<a href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=68&vd_source=5d110a858f2be0cfcf644f3a61ef01c8">11. 进阶-索引-结构-Btree_哔哩哔哩_bilibili</a></p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>索引</tag>
        <tag>Mysql存储引擎</tag>
      </tags>
  </entry>
  <entry>
    <title>什么情况下索引失效</title>
    <url>/2022/09/01/mysql3/</url>
    <content><![CDATA[<h3 id="索引失效情况：索引使用"><a href="#索引失效情况：索引使用" class="headerlink" title="索引失效情况：索引使用"></a>索引失效情况：索引使用</h3><blockquote>
<p>使用explain 分析索引是否使用</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"> explain select *from tbl_file where file_sha1&#x3D;&#39;0c4b1036671ad0b2727a9d18349d02feae0e8161&#39;;
+----+-------------+----------+------------+-------+---------------+---------------+---------+-------+------+----------+-------+
| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref   | rows | filtered | Extra |
+----+-------------+----------+------------+-------+---------------+---------------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | tbl_file | NULL       | const | idx_file_hash | idx_file_hash | 120     | const |    1 |   100.00 | NULL  |
+----+-------------+----------+------------+-------+---------------+---------------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>possible_keys ：可能索引  key：索引键</p>
<span id="more"></span>

<ul>
<li><strong>索引列上进行位运算 失效</strong></li>
</ul>
<blockquote>
<p>使用substring</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql"> explain select *from tbl_file where substring(file_sha1,1,2)&#x3D;&#39;0c&#39;;
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tbl_file | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | Using where |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> key 为NULL 索引失效</p>
</blockquote>
<ul>
<li><strong>字符串类型不加引号 失效</strong></li>
</ul>
<blockquote>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">explain select *from tbl_file where file_sha1&#x3D;123456;
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tbl_file | NULL       | ALL  | idx_file_hash | NULL | NULL    | NULL |    1 |   100.00 | Using where |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 3 warnings (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<ul>
<li><strong>索引字段使用模糊匹配，头部匹配失效，尾部匹配不会</strong></li>
</ul>
<blockquote>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">##头部匹配 失效
mysql&gt; explain select *from tbl_file where file_sha1 like &#39;%161&#39;;
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tbl_file | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    1 |   100.00 | Using where |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)
##尾部匹配 索引未失效
mysql&gt; explain select *from tbl_file where file_sha1 like &#39;0c4%&#39;;
+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+
| id | select_type | table    | partitions | type  | possible_keys | key           | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | tbl_file | NULL       | range | idx_file_hash | idx_file_hash | 120     | NULL |    1 |   100.00 | Using index condition |
+----+-------------+----------+------------+-------+---------------+---------------+---------+------+------+----------+-----------------------+
1 row in set, 1 warning (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<ul>
<li>or连 接的条件</li>
</ul>
<blockquote>
<p>用or分割开的条件，如果or前的条件中 的列有索引，而后面的列中没有索引，那么涉及的索引都不会被用到。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; explain select *from tbl_file where file_sha1&#x3D;&#39;123456&#39; or ext1&#x3D;0;
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | tbl_file | NULL       | ALL  | idx_file_hash | NULL | NULL    | NULL |    1 |   100.00 | Using where |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<ul>
<li>数据分布影响</li>
</ul>
<blockquote>
<p>如果MySQL评估使用索引比全表更慢，则不使用索引。</p>
</blockquote>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>索引</tag>
      </tags>
  </entry>
  <entry>
    <title>Go高并发数据库操作的bug——max_prepared_stmt_count</title>
    <url>/2022/09/21/mysql4/</url>
    <content><![CDATA[<h3 id="高并发情况下MySQL操作报错"><a href="#高并发情况下MySQL操作报错" class="headerlink" title="高并发情况下MySQL操作报错"></a>高并发情况下MySQL操作报错</h3><pre class="line-numbers language-none"><code class="language-none">Can&#39;t create more than max_prepared_stmt_count statements (current value: 16382)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<span id="more"></span>

<p><strong>这是mysql的preparedStatement使用超限问题</strong></p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">mysql> show global status like <span class="token string">'com_stmt%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Variable_name           <span class="token punctuation">|</span> Value  <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token punctuation">|</span> Com_stmt_execute        <span class="token punctuation">|</span> 117814 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_close          <span class="token punctuation">|</span> 104421 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_fetch          <span class="token punctuation">|</span> 0      <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_prepare        <span class="token punctuation">|</span> 126965 <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_reset          <span class="token punctuation">|</span> 0      <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_send_long_data <span class="token punctuation">|</span> 0      <span class="token punctuation">|</span>
<span class="token punctuation">|</span> Com_stmt_reprepare      <span class="token punctuation">|</span> 0      <span class="token punctuation">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
7 rows in <span class="token function">set</span> <span class="token punctuation">(</span>0<span class="token punctuation">.</span>00 sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>待解决~</strong></p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>高并发</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络1--TCP/HTTP相关</title>
    <url>/2022/08/23/netWork1/</url>
    <content><![CDATA[<p><img src="/2022/08/23/netWork1/image-20221003100929792.png" alt="image-20221003100929792"></p>
<h3 id="TCP与UDP的区别"><a href="#TCP与UDP的区别" class="headerlink" title="TCP与UDP的区别"></a>TCP与UDP的区别</h3><ol>
<li>TCP是面向连接的，UDP是无连接的；</li>
</ol>
<span id="more"></span>

<details>
<summary>什么叫无连接？</summary>
UDP发送数据之前不需要建立连接
</details>

<details>
<summary>什么叫不可靠？</summary>
UDP接收方收到报文后，不需要给出任何确认
</details>
2. TCP只支持点对点通信，UDP支持一对一、一对多、多对一、多对多；

<ol start="3">
<li>TCP是面向字节流的，UDP是面向报文的；</li>
</ol>
<details>
<summary>什么意思？</summary>
面向字节流是指发送数据时以字节为单位，一个数据包可以拆分成若干组进行发送，而UDP一个报文只能一次发完。
</details>
4. TCP有拥塞控制机制，UDP一般没有（很多研究人员已经提出一种新机制，以促使数据源(包括UDP)执行自适应的拥塞控制”）。网络出现的拥塞不会使源主机的发送速率降低，这对某些实时应用是很重要的，比如媒体通信，游戏；
5. TCP首部开销（20字节）比UDP首部开销（8字节）要大
6. UDP 的主机不需要维持复杂的连接状态表

<h5 id="什么时候选择TCP，什么时候选UDP？"><a href="#什么时候选择TCP，什么时候选UDP？" class="headerlink" title="什么时候选择TCP，什么时候选UDP？"></a>什么时候选择TCP，什么时候选UDP？</h5><details>
<summary>展开</summary>
对某些实时性要求比较高的情况，选择UDP，比如游戏，媒体通信，实时视频流（直播），即使出现传输错误也可以容忍；其它大部分情况下，HTTP都是用TCP，因为要求传输的内容可靠，不出现丢失
</details>


<h5 id="HTTP可以使用UDP吗？"><a href="#HTTP可以使用UDP吗？" class="headerlink" title="HTTP可以使用UDP吗？"></a>HTTP可以使用UDP吗？</h5><details>
<summary>展开</summary>
HTTP不可以使用UDP，HTTP需要基于可靠的传输协议，而UDP不可靠
注：http 3.0 使用udp实现
https://zh.wikipedia.org/wiki/HTTP/3
</details>



<h5 id="面向连接和无连接的区别"><a href="#面向连接和无连接的区别" class="headerlink" title="面向连接和无连接的区别"></a>面向连接和无连接的区别</h5><details>
<summary>展开</summary>


<p>无连接的网络服务（数据报服务）– 面向连接的网络服务（虚电路服务）</p>
<p>虚电路服务：首先建立连接，所有的数据包经过相同的路径，服务质量有较好的保证；</p>
<p>数据报服务：每个数据包含目的地址，数据路由相互独立（路径可能变化）；网络尽最大努力交付数据，但不保证不丢失、不保证先后顺序、不保证在时限内交付；网络发生拥塞时，可能会将一些分组丢弃；</p>
<p><img src="/2022/08/23/netWork1/20191201081919108_30577.png" alt="virtual circuit"></p>
</details>

<h3 id="TCP如何保证传输的可靠性"><a href="#TCP如何保证传输的可靠性" class="headerlink" title="TCP如何保证传输的可靠性"></a>TCP如何保证传输的可靠性</h3><ol>
<li>数据包校验</li>
<li>对失序数据包重新排序（TCP报文具有序列号）</li>
<li>丢弃重复数据</li>
<li>应答机制：接收方收到数据之后，会发送一个确认（通常延迟几分之一秒）；</li>
<li>超时重发：发送方发出数据之后，启动一个定时器，超时未收到接收方的确认，则重新发送这个数据；</li>
<li>流量控制：确保接收端能够接收发送方的数据而不会缓冲区溢出</li>
</ol>
<h3 id="HTTP和HTTPS有什么区别？"><a href="#HTTP和HTTPS有什么区别？" class="headerlink" title="HTTP和HTTPS有什么区别？"></a>HTTP和HTTPS有什么区别？</h3><ol>
<li>端口不同：HTTP使用的是80端口，HTTPS使用443端口；</li>
<li>HTTP（超文本传输协议）信息是明文传输，HTTPS运行在SSL(Secure Socket Layer)之上，添加了加密和认证机制，更加安全；</li>
<li>HTTPS由于加密解密会带来更大的CPU和内存开销；</li>
<li>HTTPS通信需要证书，一般需要向证书颁发机构（CA）购买</li>
</ol>
<h5 id="Https的连接过程？"><a href="#Https的连接过程？" class="headerlink" title="Https的连接过程？"></a>Https的连接过程？</h5><p><a href="https://www.jianshu.com/p/134ac0c381de?u_atoken=4d5e0372-5076-4d66-b619-bf0cb7b8c7ba&u_asession=011OxJ1wZGLHlyZeE3T6kil_0_KQGheqhfS2pCo8HN6r2VpxTwZqMGI4Jgyz3DfPp6X0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K-xlEAoBXfaV7pnQxa-NjBmnHmbkqVcEgdObpAroqY1_GBkFo3NEHBv0PZUm6pbxQU&u_asig=05wLUJhxR1Jl_DtooV63PVi3AeEVoEDBqb2ttdtc1UYFZXPd8pwXrXZqDIIH7dfPtDUI-VAILoVKJSOy8v5BmZrVv_qUFZuvgynEo3YvUpbgzomCX5DLwwoFkCNSFkORpQx5PsSUR4fXBTlHnDm7SpifDwYsofqZ_xUSvKtI9XtwL9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzWgKIl_KrzmkSatr2LAWjQ1GsKz2bZHzB52hkwwdR-xO6xbSxAaWh9ph0bRUFW-6vO3h9VXwMyh6PgyDIVSG1W8NAbVfL2HzgAZhMv9ZnSMcc-FijF2nFh6KRQeOtyHZY291u8H4RG9MM_EWs1ilXFUpgqTqD_xm3WQqUAZTZqrTmWspDxyAEEo4kbsryBKb9Q&u_aref=gJrmoiGyMQB75ODFyzKzHFlTnBQ=">网络协议底层原理（九）：HTTP - 简书 (jianshu.com)</a></p>
<details>
<summary>展开</summary>


<ol>
<li>客户端向服务器发送请求，同时发送客户端支持的一套加密规则（包括对称加密、非对称加密、摘要算法）；</li>
<li>服务器从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，<strong>加密公钥</strong>（用于非对称加密），以及证书的颁发机构等信息（证书中的私钥只能用于服务器端进行解密）；</li>
<li>客户端验证服务器的合法性，包括：证书是否过期，CA 是否可靠，发行者证书的公钥能否正确解开服务器证书的“发行者的数字签名”，服务器证书上的域名是否和服务器的实际域名相匹配；</li>
<li>如果证书受信任，或者用户接收了不受信任的证书，浏览器会生成一个<strong>随机密钥</strong>（用于对称算法），并用服务器提供的公钥加密（采用非对称算法对密钥加密）；使用Hash算法对握手消息进行<strong>摘要</strong>计算，并对摘要使用之前产生的密钥加密（对称算法）；将加密后的随机密钥和摘要一起发送给服务器；</li>
<li>服务器使用自己的私钥解密，得到对称加密的密钥，用这个密钥解密出Hash摘要值，并验证握手消息是否一致；如果一致，服务器使用对称加密的密钥加密握手消息发给浏览器；</li>
<li>浏览器解密并验证摘要，若一致，则握手结束。之后的数据传送都使用对称加密的密钥进行加密</li>
</ol>
<p>总结：非对称加密算法用于在握手过程中加密生成的密码；对称加密算法用于对真正传输的数据进行加密；HASH算法用于验证数据的完整性。</p>
</details>

<h5 id="输入-www-baidu-com，怎么变成-https-www-baidu-com-的，怎么确定用HTTP还是HTTPS？"><a href="#输入-www-baidu-com，怎么变成-https-www-baidu-com-的，怎么确定用HTTP还是HTTPS？" class="headerlink" title="输入 www.baidu.com，怎么变成 https://www.baidu.com 的，怎么确定用HTTP还是HTTPS？"></a>输入 <a href="http://www.baidu.com,怎么变成/">www.baidu.com，怎么变成</a> <a href="https://www.baidu.com/">https://www.baidu.com</a> 的，怎么确定用HTTP还是HTTPS？</h5><details>
<summary>展开</summary>


<p><a href="https://www.sohu.com/a/136637876_487516">你访问的网站是如何自动切换到 HTTPS 的？</a></p>
<p>一种是原始的302跳转，服务器把所有的HTTp流量跳转到HTTPS。但这样有一个漏洞，就是中间人可能在第一次访问站点的时候就劫持。<br>解决方法是引入HSTS机制，用户浏览器在访问站点的时候强制使用HTTPS。</p>
</details>

<h5 id="HTTPS连接的时候，怎么确定收到的包是服务器发来的（中间人攻击）？"><a href="#HTTPS连接的时候，怎么确定收到的包是服务器发来的（中间人攻击）？" class="headerlink" title="HTTPS连接的时候，怎么确定收到的包是服务器发来的（中间人攻击）？"></a>HTTPS连接的时候，怎么确定收到的包是服务器发来的（中间人攻击）？</h5><details>
<summary>展开</summary>


<p>1.验证域名、有效期等信息是否正确。证书上都有包含这些信息，比较容易完成验证；</p>
<p>2.判断证书来源是否合法。每份签发证书都可以根据验证链查找到对应的根证书，操作系统、浏览器会在本地存储权威机构的根证书，利用本地根证书可以对对应机构签发证书完成来源验证；</p>
<p>3.判断证书是否被篡改。需要与 CA 服务器进行校验；</p>
<p>4.判断证书是否已吊销。通过CRL（Certificate Revocation List 证书注销列表）和 OCSP（Online Certificate Status Protocol 在线证书状态协议）实现，其中 OCSP 可用于第3步中以减少与 CA 服务器的交互，提高验证效率</p>
</details>

<h5 id="什么是对称加密、非对称加密？区别是什么？"><a href="#什么是对称加密、非对称加密？区别是什么？" class="headerlink" title="什么是对称加密、非对称加密？区别是什么？"></a>什么是对称加密、非对称加密？区别是什么？</h5><details>
<summary>展开</summary>

<ul>
<li>对称加密：加密和解密采用相同的密钥。如：DES、RC2、RC4</li>
<li>非对称加密：需要两个密钥：公钥和私钥。如果用公钥加密，需要用私钥才能解密。如：RSA</li>
<li>区别：对称加密速度更快，通常用于大量数据的加密；非对称加密安全性更高（不需要传送私钥）</li>
</ul>
</details>

<h5 id="数字签名、报文摘要的原理"><a href="#数字签名、报文摘要的原理" class="headerlink" title="数字签名、报文摘要的原理"></a>数字签名、报文摘要的原理</h5><details>
<summary>展开</summary>
- 发送者A用私钥进行签名，接收者B用公钥验证签名。因为除A外没有人有私钥，所以B相信签名是来自A。A不可抵赖，B也不能伪造报文。
- 摘要算法:MD5、SHA
  </details>]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>TCP</tag>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis基础1</title>
    <url>/2022/08/19/redis1/</url>
    <content><![CDATA[<h1 id="Redis是什么"><a href="#Redis是什么" class="headerlink" title="Redis是什么"></a>Redis是什么</h1><blockquote>
<p> Redis是基于内存运行的高性能 K-V 数据库</p>
</blockquote>
<h1 id="Redis存储位置"><a href="#Redis存储位置" class="headerlink" title="Redis存储位置"></a>Redis存储位置</h1><blockquote>
<p> 内存中，所以效率高 </p>
</blockquote>
<h1 id="Redis的五种数据结构"><a href="#Redis的五种数据结构" class="headerlink" title="Redis的五种数据结构"></a>Redis的五种数据结构</h1><ul>
<li>String：Redis最基本的数据类型，一个键对应一个值，一个键值最大存储512MB</li>
<li>set：是String字符串类型的无序集合，也不可重复</li>
<li>zset：是String类型的有序集合，也不可重复。有序集合中的每个元素都需要指定一个分数，根据分数对元素进行升序排序</li>
</ul>
<span id="more"></span>

<ul>
<li>hash：hash是一个键值对的集合，是一个String类型的field和value的映射表，适合用于存储对象</li>
<li>list：是redis的简单的字符串列表，按插入顺序排序</li>
</ul>
<h1 id="Redis应用场景（可以用来做什么）"><a href="#Redis应用场景（可以用来做什么）" class="headerlink" title="Redis应用场景（可以用来做什么）"></a>Redis应用场景（可以用来做什么）</h1><blockquote>
<p> 可用于缓存，事件发布或订阅，高速队列等场景  众多语言都支持Redis，因为Redis交换数据快，在服务器中常用来存储一些需要频繁调取的数据，节省内存开销，也极大的提升了速度。 将一些热点数据存储到Redis中，要用的时候，直接从内存取，极大的提高了速度和节约了服务器的开销。  </p>
</blockquote>
<ul>
<li>会话缓存（最常用）</li>
<li>消息队列（支付）</li>
<li>活动排行榜或计数</li>
<li>发布，订阅消息（消息通知）</li>
<li>商品列表，评论列表</li>
</ul>
<h1 id="为什么使用Redis"><a href="#为什么使用Redis" class="headerlink" title="为什么使用Redis"></a>为什么使用Redis</h1><ul>
<li>完全基于内存，数据存在内存中，绝大部分请求是纯粹的内存操作，非常快速，跟传统的磁盘文件数据存储相比，避免了通过磁盘IO读取到内存这部分的开销。</li>
<li>数据结构简单，对数据操作也简单。Redis中的数据结构是专门进行设计的，每种数据结构都有一种或多种数据结构来支持。Redis正是依赖这些灵活的数据结构，来提升读取和写入的性能。</li>
<li>采用单线程，省去了很多上下文切换的时间以及CPU消耗，不存在竞争条件，不用去考虑各种锁的问题，不存在加锁释放锁操作，也不会出现死锁而导致的性能消耗。</li>
<li>使用基于IO多路复用机制的线程模型，可以处理并发的链接。</li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Go+Redis缓存控制商品数量防止超卖《基础实现版》</title>
    <url>/2022/09/18/redis2/</url>
    <content><![CDATA[<h3 id="首先了解使用Redis的思路"><a href="#首先了解使用Redis的思路" class="headerlink" title="首先了解使用Redis的思路"></a>首先了解使用Redis的思路</h3><ol>
<li>在秒杀商品页面，使用Redis缓存数据库中当前商品数量</li>
<li>运用Redis的<code>DECR</code>原子语句，减少存储value的值</li>
<li>在value&gt;=0时，使用MQ消息队列异步处理下单，数据库库存减少操作</li>
<li>value&lt;0后返回False，不执行下单操作，缓解数据库压力</li>
</ol>
<span id="more"></span>

<h3 id="Go-Redis代码实现思路"><a href="#Go-Redis代码实现思路" class="headerlink" title="Go+Redis代码实现思路"></a>Go+Redis代码实现思路</h3><ol>
<li>首先使用Go语言第三方库<code>github.com/garyburd/redigo/redis</code>，建立redis连接池</li>
</ol>
<blockquote>
<p>为什么要建立redis连接池？</p>
<p>redis连接方式是客户端/服务端的TCP连接，多次使用redis直接连接，会导致可能redis连接的时间比处理数据的时间还长，</p>
<p>效率不高，这并不是我们想要的，通过建立连接池的方式，想连接就使用，不想连接，就放回连接池，极大提高redis使用效率。</p>
</blockquote>
<ol start="2">
<li>在商品页面缓存商品数量</li>
<li>秒杀接口扣除商品数量防止超卖</li>
</ol>
<h4 id="连接池代码如下"><a href="#连接池代码如下" class="headerlink" title="连接池代码如下"></a>连接池代码如下</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> common

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/garyburd/redigo/redis"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	pool <span class="token operator">*</span>redis<span class="token punctuation">.</span>Pool
	<span class="token comment">//使用红帽 ACL 系统连接到红帽实例</span>
	redisHost <span class="token operator">=</span> <span class="token string">"127.0.0.1:6379"</span>
	<span class="token comment">//redisHost = ":6379"</span>
	<span class="token comment">//密码</span>
	redisPass <span class="token operator">=</span> <span class="token string">""</span>
<span class="token punctuation">)</span>

<span class="token comment">// newRedisPool : 创建redis连接池</span>
<span class="token keyword">func</span> <span class="token function">newRedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>redis<span class="token punctuation">.</span>Pool <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Pool<span class="token punctuation">&#123;</span>
		MaxIdle<span class="token punctuation">:</span>     <span class="token number">50</span><span class="token punctuation">,</span>
		MaxActive<span class="token punctuation">:</span>   <span class="token number">0</span><span class="token punctuation">,</span>
		IdleTimeout<span class="token punctuation">:</span> <span class="token number">300</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
		Dial<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// 1. 打开连接</span>
			c<span class="token punctuation">,</span> err <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> redisHost<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
			<span class="token punctuation">&#125;</span>

			<span class="token comment">// 2. 访问认证</span>
			<span class="token comment">//if _, err = c.Do("AUTH", redisPass); err != nil &#123;</span>
			<span class="token comment">//	c.Close()</span>
			<span class="token comment">//	return nil, err</span>
			<span class="token comment">//&#125;</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>redisPass<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 有密码的情况</span>
				<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"AUTH"</span><span class="token punctuation">,</span> redisPass<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					c<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 没有密码的时候 ping 连接</span>
				<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"ping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					c<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token comment">//检测Redis是否可用</span>
		TestOnBorrow<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>conn redis<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">&lt;</span> time<span class="token punctuation">.</span>Minute <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">&#125;</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"PING"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pool <span class="token operator">=</span> <span class="token function">newRedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">RedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>redis<span class="token punctuation">.</span>Pool <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> pool
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="缓存商品数量"><a href="#缓存商品数量" class="headerlink" title="缓存商品数量"></a>缓存商品数量</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// GetDetailr 秒杀页面/商品详情页 需要用户登录才能看 curl //detailr--------Redis</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>ProductController<span class="token punctuation">)</span> <span class="token function">GetDetailr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mvc<span class="token punctuation">.</span>View <span class="token punctuation">&#123;</span>
	<span class="token comment">//固定产品测试</span>
	product<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>ProductService<span class="token punctuation">.</span><span class="token function">GetProductByID</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//fmt.Println("-----------产品路径------------", product)</span>
	<span class="token comment">//p.Ctx.Redirect("/product/Localnum")</span>
	<span class="token comment">//redis 缓存商品数量</span>
	rConn <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">RedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rConn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> rConn<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"SET"</span><span class="token punctuation">,</span> <span class="token string">"Count"</span><span class="token punctuation">,</span> product<span class="token punctuation">.</span>ProductNum<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"set字符串失败，"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> mvc<span class="token punctuation">.</span>View<span class="token punctuation">&#123;</span>
		<span class="token comment">//商品详情布局文件</span>
		Layout<span class="token punctuation">:</span> <span class="token string">"shared/productLayout.html"</span><span class="token punctuation">,</span>
		<span class="token comment">//页面模板</span>
		Name<span class="token punctuation">:</span> <span class="token string">"product/view.html"</span><span class="token punctuation">,</span>
		Data<span class="token punctuation">:</span> iris<span class="token punctuation">.</span>Map<span class="token punctuation">&#123;</span>
			<span class="token string">"product"</span><span class="token punctuation">:</span> product<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="秒杀接口"><a href="#秒杀接口" class="headerlink" title="秒杀接口"></a>秒杀接口</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// GetQrder 测试接口 改进前 使用Redis</span>
<span class="token comment">// go-wrk -c 80 -d 5 http://localhost:8082/product/rrder</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>ProductController<span class="token punctuation">)</span> <span class="token function">GetRrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//通过消息队列 缓解订单更新数据库压力</span>
	<span class="token comment">//productIDString转换成int64</span>
	productID <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

	userID <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token comment">//连接redis</span>
	rConn <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">RedisPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rConn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> val<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rConn<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"DECR"</span><span class="token punctuation">,</span> <span class="token string">"Count"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> val <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//创建消息体</span>
		message <span class="token operator">:=</span> datamodels<span class="token punctuation">.</span><span class="token function">NewMessage</span><span class="token punctuation">(</span>productID<span class="token punctuation">,</span> userID<span class="token punctuation">)</span>
		<span class="token comment">//类型转化 成rabbitmq可以传送的消息</span>
		byteMessage<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">//使用Simple模式消息队列 实例定义好的模式</span>
		err <span class="token operator">=</span> p<span class="token punctuation">.</span>RabbitMQ<span class="token punctuation">.</span><span class="token function">PublishSimple</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>byteMessage<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>Ctx<span class="token punctuation">.</span><span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"消费ing"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"卖完了"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"false"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="MQ消息队列"><a href="#MQ消息队列" class="headerlink" title="MQ消息队列"></a>MQ消息队列</h4><h5 id="消息队列消费微服务"><a href="#消息队列消费微服务" class="headerlink" title="消息队列消费微服务"></a>消息队列消费微服务</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"imooc-Product/common"</span>
	<span class="token string">"imooc-Product/rabbitmq"</span>
	<span class="token string">"imooc-Product/repositories"</span>
	<span class="token string">"imooc-Product/services"</span>
<span class="token punctuation">)</span>

<span class="token comment">/*
	消费端代码
*/</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//获取数据库实例</span>
	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">NewMysqlConn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">//创建product数据库操作实例</span>
	product <span class="token operator">:=</span> repositories<span class="token punctuation">.</span><span class="token function">NewProductManager</span><span class="token punctuation">(</span><span class="token string">"product"</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span>
	<span class="token comment">//创建 product service</span>
	productService <span class="token operator">:=</span> services<span class="token punctuation">.</span><span class="token function">NewProductService</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
	<span class="token comment">//创建order 数据库操作实例</span>
	order <span class="token operator">:=</span> repositories<span class="token punctuation">.</span><span class="token function">NewOrderManager</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span>
	<span class="token comment">//创建 order service</span>
	orderService <span class="token operator">:=</span> services<span class="token punctuation">.</span><span class="token function">NewOrderService</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
	<span class="token comment">//消息队列消费者</span>
	rabbitmqConsumer <span class="token operator">:=</span> rabbitmq<span class="token punctuation">.</span><span class="token function">NewRabbitMQSimple</span><span class="token punctuation">(</span><span class="token string">"imoocProduct"</span><span class="token punctuation">)</span>
	<span class="token comment">//进行消费</span>
	rabbitmqConsumer<span class="token punctuation">.</span><span class="token function">ConsumeSimple</span><span class="token punctuation">(</span>orderService<span class="token punctuation">,</span> productService<span class="token punctuation">)</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="MQ订单消费"><a href="#MQ订单消费" class="headerlink" title="MQ订单消费"></a>MQ订单消费</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ConsumeSimple  ----------step:3. 简单模式下消费者</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RabbitMQ<span class="token punctuation">)</span> <span class="token function">ConsumeSimple</span><span class="token punctuation">(</span>orderService services<span class="token punctuation">.</span>IOrderService<span class="token punctuation">,</span> productService services<span class="token punctuation">.</span>IProductService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">//1. 申请队列，如果队列不存在会自动创建，如果存在则跳过创建（保证队列存在，消息能发送到队列中）</span>
   <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">QueueDeclare</span><span class="token punctuation">(</span>
      r<span class="token punctuation">.</span>QueueName<span class="token punctuation">,</span>
      <span class="token comment">//是否持久化</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//是否自动删除</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//是否具有排他性</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//是否阻塞</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//额外属性</span>
      <span class="token boolean">nil</span><span class="token punctuation">,</span>
   <span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>
   <span class="token comment">//消费者控流</span>
   r<span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">Qos</span><span class="token punctuation">(</span>
      <span class="token number">1</span><span class="token punctuation">,</span>     <span class="token comment">//当前消费者一次能接受最大消息数量1个</span>
      <span class="token number">0</span><span class="token punctuation">,</span>     <span class="token comment">//服务器传递的最大容量（）以8位字节为单位</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//如果为true 对channel可用</span>
   <span class="token punctuation">)</span>

   <span class="token comment">//2. 接受消息</span>
   msgs<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>channel<span class="token punctuation">.</span><span class="token function">Consume</span><span class="token punctuation">(</span>
      r<span class="token punctuation">.</span>QueueName<span class="token punctuation">,</span>
      <span class="token comment">//用来区分多个消费者</span>
      <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token comment">//是否自动应答</span>
      <span class="token comment">//可改手动修改【false】 控制速率</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//是否独有</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//如果设置为true，表示不能将同一个connection中发送的消息传递给这个connection中的消费者</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">//是否阻塞 false为阻塞</span>
      <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token boolean">nil</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>
   forever <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
   <span class="token comment">//启用协程处理消息</span>
   <span class="token keyword">var</span> num <span class="token builtin">int</span>
   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> msgs <span class="token punctuation">&#123;</span>

         <span class="token comment">//实现我们要处理的逻辑函数</span>
         <span class="token comment">//log.Printf("Received a message:%s", d.Body)</span>
         message <span class="token operator">:=</span> <span class="token operator">&amp;</span>datamodels<span class="token punctuation">.</span>Message<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
         err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
         <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
         <span class="token punctuation">&#125;</span>
         num<span class="token operator">++</span>
         fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Received a message:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"第："</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
         <span class="token comment">//数据库插入订单</span>
         <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> orderService<span class="token punctuation">.</span><span class="token function">InsertOrderByMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
         <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
         <span class="token punctuation">&#125;</span>

         <span class="token comment">//</span>
         err <span class="token operator">=</span> productService<span class="token punctuation">.</span><span class="token function">SubNumberOne</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>ProductID<span class="token punctuation">)</span>
         <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
         <span class="token punctuation">&#125;</span>
         <span class="token comment">//如果为true 表示确认所有未确认的消息</span>
         <span class="token comment">//为false 表示确认当前消息</span>
         d<span class="token punctuation">.</span><span class="token function">Ack</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">//手动确认消息 正确才下一个 保障数据不丢失</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[*] Waiting for message,To exit press CTRL+C"</span><span class="token punctuation">)</span>
   <span class="token comment">//forever里面没有元素，使用这种方法让协程保持阻塞 这样主程序不会死掉</span>
   <span class="token operator">&lt;-</span>forever
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="代码中的重点"><a href="#代码中的重点" class="headerlink" title="代码中的重点"></a>代码中的重点</h4><ol>
<li>Redis端</li>
</ol>
<p>数量判断必须与该数量减少原子语句操作在同一语句，否则高并发下仍然会发生超卖现象</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">if</span> val<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>rConn<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token string">"DECR"</span><span class="token punctuation">,</span> <span class="token string">"Count"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> val <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>MySQL端</li>
</ol>
<p>为避免高并发下超卖，更新操作在SQL中使用数量减少的原子语句</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">sql</span> :<span class="token operator">=</span> <span class="token string">"update "</span> <span class="token operator">+</span> p<span class="token punctuation">.</span><span class="token keyword">table</span> <span class="token operator">+</span> <span class="token string">" set "</span> <span class="token operator">+</span> <span class="token string">" productNum=productNum-1 where ID="</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>使用</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Go+Map写k-v数据库（SET-GET简单实现TCP优化版）</title>
    <url>/2022/10/02/go22/</url>
    <content><![CDATA[<h3 id="通过实现一个简单的K–V存储数据库，学习Go语言（五）"><a href="#通过实现一个简单的K–V存储数据库，学习Go语言（五）" class="headerlink" title="通过实现一个简单的K–V存储数据库，学习Go语言（五）"></a>通过实现一个简单的K–V存储数据库，学习Go语言（五）</h3><blockquote>
<p>优化客户端端口重连</p>
<p>优化服务端断开问题</p>
<p>下一步优化—-使用协程发送消息</p>
</blockquote>
<span id="more"></span>

<ul>
<li>服务端</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//net.Listen() 函数用于监听连接,如果第二个参数不包含 IP 地址，只有端口号的话，net.Listen()</span>
	<span class="token comment">//将监听本地系统上所有可用的 IP 地址。</span>
	listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"localhost:5000"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"myRedis localhost:5000 启动..."</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//多次连接</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listen<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"客户端连接成功啦！"</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">//获取客户端发来的消息</span>
			data<span class="token punctuation">,</span> err <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token comment">//断开，重新连接，开启新连接</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"客户端断开连接...\n%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">//strings.TrimSpace(data)去掉字符串的 回车 13 换行符 10</span>
			sendMsg <span class="token operator">:=</span> <span class="token function">myRedis</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"接受客户端消息为："</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			<span class="token comment">//发送给客户端</span>
			<span class="token keyword">if</span> sendMsg <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
				conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>sendMsg <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

		<span class="token punctuation">&#125;</span>

	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>客户端</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">//连接服务端</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> <span class="token string">"localhost:5000"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">//通过io输入消息给服务端</span>
		reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">)</span>
		<span class="token comment">//分行发送消息</span>
		text<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token comment">//标准格式，通过conn数据发送</span>
		<span class="token comment">//fmt.Fprintf(conn, text)</span>
		conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">//读取接受消息</span>
		acceptMsg<span class="token punctuation">,</span> err <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"服务端端断开连接...\n%s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>acceptMsg<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>map</tag>
      </tags>
  </entry>
  <entry>
    <title>协程---channel 练习</title>
    <url>/2022/10/03/go23/</url>
    <content><![CDATA[<h3 id="1-用协程实现顺序打印123"><a href="#1-用协程实现顺序打印123" class="headerlink" title="1. 用协程实现顺序打印123"></a>1. 用协程实现顺序打印123</h3><pre class="line-numbers language-none"><code class="language-none">func main() &#123;
	ch :&#x3D; make(chan int)
	for i :&#x3D; 1; i &lt;&#x3D; 3; i++ &#123;
		go func() &#123;
			fmt.Println(&lt;-ch)
		&#125;()
		ch &lt;- i
		time.Sleep(time.Second)
	&#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<span id="more"></span>

<h3 id="2-用Channel和两个协程实现数组相加"><a href="#2-用Channel和两个协程实现数组相加" class="headerlink" title="2. 用Channel和两个协程实现数组相加"></a>2. 用Channel和两个协程实现数组相加</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//用Channel和两个协程实现数组相加</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	num1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>
	num2 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>
	res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	ch2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	sum <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token operator">&lt;-</span>sum
			ch1 <span class="token operator">&lt;-</span> num1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			ch2 <span class="token operator">&lt;-</span> num2<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			tem <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch1 <span class="token operator">+</span> <span class="token operator">&lt;-</span>ch2
			res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tem
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"+"</span><span class="token punctuation">,</span> tem<span class="token punctuation">)</span>

		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		sum <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="all-goroutines-are-asleep-deadlock-Go中协程死锁详解"><a href="#all-goroutines-are-asleep-deadlock-Go中协程死锁详解" class="headerlink" title="all goroutines are asleep - deadlock-Go中协程死锁详解"></a>all goroutines are asleep - deadlock-Go中协程死锁详解</h4><blockquote>
<p>channel 程序写的不对很容易发生死锁</p>
</blockquote>
<p>这究竟是咋回事呢？<br>首先我们这里通过make(chan int)，开辟的通道是一种<strong>无缓冲通道</strong>，所以当对这个缓冲通道写的时候，会一直阻塞等到某个协程对这个缓冲通道读（大家发现没有这个与典型的生产者消费者有点不一样，当队列中“内容”已经满了，生产者再生往里放东西才会阻塞，而这里我讲ch&lt;-   理解为生产，他却是需要等到某个协程读了再能继续运行）。<br>main函数的执行在go语言中本身就是一个协程的执行，所以在执行到c&lt;-‘A’的时候，执行main函数的协程将被阻塞，换句话说main函数被阻塞了，此时不能在继续往下执行了，所以整个程序阻塞，发生了死锁。</p>
<h3 id="3-数字字母交替打印"><a href="#3-数字字母交替打印" class="headerlink" title="3. 数字字母交替打印"></a>3. 数字字母交替打印</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//用GO写数字字母交替打印的协程，要求使用两个协程分别打印</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
   <span class="token comment">//ch2 := make(chan int)</span>
   tem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
         <span class="token operator">&lt;-</span>tem
         fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
         ch <span class="token operator">&lt;-</span> i
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      c <span class="token operator">:=</span> <span class="token char">'A'</span>
      <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
         <span class="token operator">&lt;-</span>ch
         fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
         c<span class="token operator">++</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
      tem <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>Channel</tag>
        <tag>goroutine</tag>
      </tags>
  </entry>
  <entry>
    <title>通过Linux系统抓包，学习TCP</title>
    <url>/2022/10/04/linux4/</url>
    <content><![CDATA[<h3 id="Linux命令实战"><a href="#Linux命令实战" class="headerlink" title="Linux命令实战"></a>Linux命令实战</h3><p><a href="https://www.bilibili.com/video/BV1Gr4y1F7UV/?p=5&vd_source=5d110a858f2be0cfcf644f3a61ef01c8">【TCP/IP协议】数据包如何发送出去_哔哩哔哩_bilibili</a></p>
<p>开启3个命令窗口</p>
<ol>
<li>获取baidu.com ip地址</li>
</ol>
<blockquote>
<p><a href="https://blog.csdn.net/zhuimeng_by/article/details/105120437">Linux查看DNS地址以及端口，nslookup命令以及更强大的dig命令_beyond_champion的博客-CSDN博客_nslookup 端口</a></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">lighthouse@VM-12-11-ubuntu:~$ nslookup baidu.com
Server:         127.0.0.53
Address:        127.0.0.53#53

Non-authoritative answer:
Name:   baidu.com
Address: 39.156.66.10
Name:   baidu.com
Address: 110.242.68.66<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<span id="more"></span>

<ol start="2">
<li>使用 110.242.68.66为抓包地址，开启抓包监听</li>
</ol>
<blockquote>
<p><a href="https://blog.csdn.net/qq_39825430/article/details/127113677">Tcpdump抓包命令_游子丿的博客-CSDN博客</a></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">tcpdump -i any -nn host 110.242.68.66<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>连接baidu.com域名</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">curl baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="4">
<li>查看tcpdump抓包记录</li>
</ol>
<p><img src="/2022/10/04/linux4/image-20221004184906655.png" alt="image-20221004184906655"></p>
<blockquote>
<p>马赛克部分为我内网ip</p>
</blockquote>
<p>[s]表示SYN</p>
<p>[s.]表示SYN+ACK</p>
<p>[.]表示ACK</p>
<p>[p.]表示push+ack 立即发送数据包，有3个是因为发送长度有限制，需要多次才能发完</p>
<p>[F]表示Finsh</p>
<p>上述截图 表示了完整的三次握手和四次挥手过程</p>
<p>待学习~</p>
<p><a href="https://www.cnblogs.com/nmap/p/6148306.html">nc命令用法举例 - nmap - 博客园 (cnblogs.com)</a></p>
<p><a href="https://linux.cn/article-2434-1.html">技术|netstat 的10个基本用法 (linux.cn)</a></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>命令行实战</tag>
      </tags>
  </entry>
  <entry>
    <title>腾讯COS公有云-golang上传-下载</title>
    <url>/2022/10/06/go24/</url>
    <content><![CDATA[<h3 id="使用腾讯公有云COS"><a href="#使用腾讯公有云COS" class="headerlink" title="使用腾讯公有云COS"></a>使用腾讯公有云COS</h3><blockquote>
<p>安装SDK，访问官网<a href="https://cloud.tencent.com/document/product/436/31215">对象存储 快速入门-SDK 文档-文档中心-腾讯云 (tencent.com)</a></p>
</blockquote>
<span id="more"></span>

<ol>
<li>创建COS连接客户端</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> cos

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/tencentyun/cos-go-sdk-v5"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"net/url"</span>
	<span class="token string">"storage-cloud/config"</span>
<span class="token punctuation">)</span>
<span class="token keyword">var</span> cosCli <span class="token operator">*</span>cos<span class="token punctuation">.</span>Client
<span class="token comment">// Client : 创建oss client对象</span>
<span class="token keyword">func</span> <span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>cos<span class="token punctuation">.</span>Client <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> cosCli <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> cosCli
	<span class="token punctuation">&#125;</span>
    <span class="token comment">//https://console.cloud.tencent.com/cos5/bucket, 关于地域的详情见 https://cloud.tencent.com/document/product/436/6224</span>
	u<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>BucketURL<span class="token punctuation">)</span>
	<span class="token comment">// 用于Get Service 查询，默认全地域 service.cos.myqcloud.com</span>
	su<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ServiceURL<span class="token punctuation">)</span>
	b <span class="token operator">:=</span> <span class="token operator">&amp;</span>cos<span class="token punctuation">.</span>BaseURL<span class="token punctuation">&#123;</span>BucketURL<span class="token punctuation">:</span> u<span class="token punctuation">,</span> ServiceURL<span class="token punctuation">:</span> su<span class="token punctuation">&#125;</span>
	<span class="token comment">// 1.永久密钥</span>
	cosCli <span class="token operator">=</span> cos<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>
		Transport<span class="token punctuation">:</span> <span class="token operator">&amp;</span>cos<span class="token punctuation">.</span>AuthorizationTransport<span class="token punctuation">&#123;</span>
			SecretID<span class="token punctuation">:</span>  config<span class="token punctuation">.</span>SECRETID<span class="token punctuation">,</span>  <span class="token comment">// 替换为用户的 SecretId，请登录访问管理控制台进行查看和管理，https://console.cloud.tencent.com/cam/capi</span>
			SecretKey<span class="token punctuation">:</span> config<span class="token punctuation">.</span>SecretKey<span class="token punctuation">,</span> <span class="token comment">// 替换为用户的 SecretKey，请登录访问管理控制台进行查看和管理，https://console.cloud.tencent.com/cam/capi</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> cosCli
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>上传示例（使用预签名URL上传）</li>
</ol>
<blockquote>
<p>使用该方法主要为了添加Header，使上传文件包含文件类型元信息，促使下载时能直接下载为该类型文件</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//腾讯云COS上传</span>
		c <span class="token operator">:=</span> cos<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		cosPath <span class="token operator">:=</span> COSLocation <span class="token operator">+</span> fileMeta<span class="token punctuation">.</span>FileSha1
		<span class="token comment">// 1. 获取预签名URL </span>
		presignedURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetPresignedURL</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>MethodPut<span class="token punctuation">,</span> cosPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SECRETID<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SecretKey<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// 2. 通过预签名方式上传对象</span>
		req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>MethodPut<span class="token punctuation">,</span> presignedURL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newFile<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">//head为 file, head, err := r.FormFile("file") http上传文件的元信息</span>
		contentType <span class="token operator">:=</span> head<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span>
		<span class="token comment">// 用户可自行设置请求头部</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> contentType<span class="token punctuation">)</span>
		<span class="token comment">//使浏览器不自动预览</span>
		req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span> <span class="token string">"attachment"</span><span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>下载接口（使用预签名URL下载）</li>
</ol>
<blockquote>
<p>方便直接通过URL浏览器下载</p>
<p>也可使用官网其他方法<a href="https://cloud.tencent.com/document/product/436/65646">对象存储 下载对象-SDK 文档-文档中心-腾讯云 (tencent.com)</a></p>
<p>如果需要通过浏览器下载，也可如下：</p>
<p>示例</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 1. 从响应体中获取对象</span>
resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> opt<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
     <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
data<span class="token punctuation">,</span> err<span class="token operator">:=</span>ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>
<span class="token comment">//识别http浏览器响应头 让浏览器识别出是文件下载</span>
w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>FileTypeHeader<span class="token punctuation">,</span> FileTypeHeaderValue<span class="token punctuation">)</span>
w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>FileDisHeader<span class="token punctuation">,</span> FileDisHeaderValue<span class="token operator">+</span><span class="token operator">&lt;</span>你文件的名称：FileName<span class="token operator">></span><span class="token operator">+</span><span class="token string">"\""</span><span class="token punctuation">)</span>
w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>预签名URL方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 1.获取对象访问 URL</span>
cosPath <span class="token operator">:=</span> row<span class="token punctuation">.</span>FileAddr<span class="token punctuation">.</span>String
c <span class="token operator">:=</span> cos<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 获取预签名URL</span>
presignedURL<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token function">GetPresignedURL</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>MethodGet<span class="token punctuation">,</span> cosPath<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SECRETID<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SecretKey<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//通过预签名URL下载对象</span>
w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>presignedURL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>go语言</category>
      </categories>
      <tags>
        <tag>OSS</tag>
      </tags>
  </entry>
</search>
